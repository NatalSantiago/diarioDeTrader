<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>DiÃ¡rio de Trader - v4.1</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://i.ibb.co/svX1wDjK/Logo-Diario.png">
    <!-- SweetAlert2, CryptoJS, Chart.js, SheetJS (XLSX) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <style>
        /* ========== CSS ORIGINAL COMPLETO ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            transition: background-color 0.2s ease, border-color 0.2s, color 0.2s;
        }

        :root {
            --bg-body: #0a0c12;
            --bg-card: #14181f;
            --surface: #1e232c;
            --surface-hover: #2a313e;
            --text-primary: #f0f4fa;
            --text-secondary: #9aa8b9;
            --accent: #3b82f6;
            --accent-glow: #2563eb;
            --success: #10b981;
            --success-bg: rgba(16, 185, 129, 0.15);
            --danger: #ef4444;
            --danger-bg: rgba(239, 68, 68, 0.15);
            --warning: #f59e0b;
            --border: #2a313e;
            --divider: #2f3747;
            --input-bg: #1a1f29;
            --shadow: 0 12px 30px -8px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(255, 255, 255, 0.02) inset;
            --glow: 0 0 12px rgba(59,130,246,0.3);
        }

        body.light-theme {
            --bg-body: #eef2f6;
            --bg-card: #ffffff;
            --surface: #f4f7fc;
            --surface-hover: #e9ecf2;
            --text-primary: #121826;
            --text-secondary: #3e4a5c;
            --accent: #2563eb;
            --accent-glow: #3b82f6;
            --success: #0f9d58;
            --success-bg: rgba(16, 185, 129, 0.1);
            --danger: #dc2626;
            --danger-bg: rgba(220, 38, 38, 0.08);
            --border: #cfddee;
            --divider: #d0ddea;
            --input-bg: #ffffff;
            --shadow: 0 8px 28px -12px rgba(0, 35, 70, 0.25), 0 0 0 1px rgba(0,0,0,0.05) inset;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            padding: 1rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .dashboard {
            max-width: 1440px;
            width: 100%;
        }

        .top-bar {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            gap: 1rem;
        }
        .logo h1 {
            font-weight: 600;
            font-size: 1.9rem;
            background: linear-gradient(145deg, var(--accent), #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
        }
        .theme-toggle {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 3rem;
            padding: 0.5rem;
            display: flex;
            gap: 0.5rem;
            box-shadow: var(--shadow);
        }
        .theme-btn {
            background: transparent;
            border: none;
            padding: 0.5rem 1.2rem;
            border-radius: 2rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            transition: 0.15s;
        }
        .theme-btn.active {
            background: var(--accent);
            color: white;
            box-shadow: var(--glow);
        }
        .backup-btn {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 2rem;
            padding: 0.5rem 1.2rem;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }
        .launch-btn {
            background: var(--accent);
            border: none;
            border-radius: 2rem;
            padding: 0.7rem 2rem;
            color: white;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--glow);
        }
        .dashboard-btn {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 2rem;
            padding: 0.5rem 1.5rem;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .card {
            background: var(--bg-card);
            border-radius: 1.8rem;
            padding: 1.4rem 1.2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: transform 0.1s, border-color 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .card.meta-atingida {
            border-color: var(--success);
            box-shadow: 0 0 0 2px var(--success-bg), var(--shadow);
        }
        .card-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            flex-wrap: wrap;
        }
        .card-value {
            font-size: 1.9rem;
            font-weight: 600;
            line-height: 1.2;
        }
        .card-value small {
            font-size: 0.9rem;
            font-weight: 400;
            color: var(--text-secondary);
            margin-left: 0.3rem;
        }
        .progress-meta {
            font-size: 0.9rem;
            color: var(--accent);
            font-weight: 500;
            margin-top: 0.5rem;
        }
        .badge {
            background: var(--surface-hover);
            padding: 0.2rem 0.7rem;
            border-radius: 30px;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .badge.danger-atingido {
            background: var(--danger-bg);
            border: 1px solid var(--danger);
            color: var(--danger);
        }
        .divider {
            height: 1px;
            background: var(--divider);
            margin: 1.5rem 0 1rem 0;
            width: 100%;
        }

        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            margin: 1.5rem 0 1rem;
            background: var(--surface);
            padding: 1rem 1.5rem;
            border-radius: 3rem;
        }
        .filter-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .filter-item label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .filter-item select, .filter-item input {
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 2rem;
            padding: 0.4rem 1rem;
            color: var(--text-primary);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.4rem 1rem;
            border-radius: 2rem;
            font-size: 0.8rem;
            cursor: pointer;
        }
        .btn-print {
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 0.4rem 1rem;
            border-radius: 2rem;
            font-size: 0.8rem;
            cursor: pointer;
            margin-left: 1rem;
        }
        .btn-success {
            background: transparent;
            border: 1px solid var(--success);
            color: var(--success);
            padding: 0.4rem 1rem;
            border-radius: 2rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: 0.1s;
        }
        .btn-success:hover {
            background: var(--success-bg);
        }
        .btn-danger {
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 0.4rem 1rem;
            border-radius: 2rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: 0.1s;
        }
        .btn-danger:hover {
            background: var(--danger-bg);
        }
        .btn-info {
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 0.4rem 1rem;
            border-radius: 2rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: 0.1s;
        }
        .btn-info:hover {
            background: var(--accent);
            color: white;
        }

        .trades-list {
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }
        .trade-item {
            background: var(--surface);
            border-radius: 1.5rem;
            padding: 1rem 1.5rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            border-left: 5px solid var(--accent);
            gap: 1rem;
        }
        .trade-info {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1.5rem;
        }
        .trade-status {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .status-badge {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.2rem 0.8rem;
            border-radius: 20px;
            background: var(--surface-hover);
        }
        .status-aberto { color: var(--warning); border: 1px solid var(--warning); }
        .status-fechado { color: var(--success); border: 1px solid var(--success); }

        /* Estilos para impressÃ£o */
        @media print {
            .print-frame, .print-frame * {
                visibility: visible;
            }
            .print-frame {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                color: black;
                padding: 1rem;
            }
        }

        @media (max-width: 640px) {
            .card-value { font-size: 1.5rem; }
        }

        /* Estilos originais para os modais */
        .swal2-popup {
            background: var(--bg-card) !important;
            color: var(--text-primary) !important;
            width: 85% !important;
            max-width: 1200px !important;
        }
        .swal2-title {
            color: var(--text-primary) !important;
        }
        .modal-field {
            margin-bottom: 1rem;
            width: 100%;
        }
        .modal-field label {
            display: block;
            text-align: left;
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 0.3rem;
        }
        .modal-field input, .modal-field select, .modal-field textarea {
            width: 100%;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 0.8rem 1rem;
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        .modal-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .modal-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }
        .modal-btn-primary {
            background: var(--accent);
            color: white;
            padding: 0.8rem 2rem;
            border-radius: 2rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }
        .modal-btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.8rem 2rem;
            border-radius: 2rem;
            cursor: pointer;
        }
        .modal-btn-print {
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 0.8rem 2rem;
            border-radius: 2rem;
            cursor: pointer;
        }
        .modal-image-area {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--surface);
            border-radius: 1rem;
            padding: 0.5rem 1rem;
            border: 1px dashed var(--accent);
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }
        .modal-image-preview {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            object-fit: cover;
        }
        .zoom-image-btn {
            background: var(--accent);
            border: 1px solid var(--accent);
            color: white;
            border-radius: 2rem;
            padding: 0.3rem 0.8rem;
            font-size: 0.7rem;
            cursor: pointer;
            margin-left: 0.5rem;
        }
        .clear-image-btn {
            background: var(--danger-bg);
            border: 1px solid var(--danger);
            color: var(--danger);
            border-radius: 2rem;
            padding: 0.3rem 0.8rem;
            font-size: 0.7rem;
            cursor: pointer;
        }

        /* Estilos especÃ­ficos para o modal de ConfiguraÃ§Ãµes (compacto) */
        .config-swal {
            width: 500px !important;
            padding: 1.5rem !important;
        }
        .config-grid {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
            padding: 0 0.5rem;
        }
        .config-row {
            display: flex;
            gap: 1.5rem;
            align-items: center;
            justify-content: flex-start;
        }
        .config-row .field-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }
        .config-row .field-group label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            font-weight: 600;
            text-align: left;
        }
        .config-row .field-group input,
        .config-row .field-group select {
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 0.8rem;
            padding: 0.6rem 1rem;
            color: var(--text-primary);
            font-size: 0.9rem;
            width: 100%;
        }
        .config-full {
            width: 100%;
        }
        .config-full .field-group {
            width: 100%;
        }

        /* Estilos para o modal do Dashboard */
        .dashboard-modal {
            width: 90% !important;
            max-width: 1200px !important;
            padding: 1.5rem !important;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-top: 1rem;
        }
        .dashboard-card {
            background: var(--surface);
            border-radius: 1rem;
            padding: 1rem;
            border: 1px solid var(--border);
        }
        .dashboard-card h3 {
            font-size: 1rem;
            margin-bottom: 1rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .dashboard-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: space-around;
            margin-bottom: 1rem;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--accent);
        }
        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        .dashboard-chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
        .dashboard-print-btn {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 1rem;
        }
        .dashboard-row-split {
            display: flex;
            gap: 1.5rem;
            width: 100%;
        }
        .dashboard-row-split > div {
            flex: 1;
            min-width: 0;
        }

        /* Seletor de contas */
        .conta-selector {
            display: flex;
            align-items: center;
            background: var(--surface);
            border-radius: 3rem;
            padding: 0.2rem 0.2rem 0.2rem 1rem;
            border: 1px solid var(--border);
        }
        .conta-selector select {
            background-color: var(--input-bg);
            color: var(--text-primary);
            border: none;
            font-size: 1rem;
            padding: 0.75rem 2rem 0.75rem 1rem;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%239aa8b9' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1rem;
            cursor: pointer;
            border-radius: 2rem;
            width: 100%;
        }
        .conta-selector select:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--accent);
        }

        /* Modal de gerenciamento de contas */
        .contas-modal {
            width: 90% !important;
            max-width: 1000px !important;
        }
        .contas-header {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 1rem;
        }
        .contas-header button {
            background: var(--accent);
            border: none;
            border-radius: 2rem;
            color: white;
            padding: 0.5rem 1.5rem;
            font-size: 0.9rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .contas-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .contas-table th {
            background: var(--surface-hover);
            padding: 0.75rem;
            text-align: left;
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--text-secondary);
        }
        .contas-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
        }
        .contas-table tr:hover {
            background: var(--surface-hover);
        }
        .contas-actions {
            display: flex;
            gap: 0.5rem;
        }
        .contas-actions button {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 1.5rem;
            padding: 0.3rem 0.8rem;
            font-size: 0.8rem;
            cursor: pointer;
            color: var(--text-primary);
        }
        .contas-actions button:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
    </style>
</head>
<body>
    <div class="dashboard" id="app">
        <!-- top bar tema + backups + dashboard + gerenciar contas + importar -->
        <div class="top-bar">
            <div class="logo"><h1>â—‰ DIÃRIO DE TRADER - v4.1</h1></div>
            <div style="display: flex; gap: 0.8rem; align-items: center; flex-wrap: wrap;">
                <button class="dashboard-btn" id="dashboardButton">ğŸ“Š Dashboard</button>
                <button class="backup-btn" id="gerenciarContasBtn">ğŸ“‹ Gerenciar Contas</button>
                <button class="backup-btn" id="importarMT5Btn">ğŸ“¥ Importar Trades (MT5)</button>
                <input type="file" id="arquivoMT5" accept=".xlsx,.xls,.csv" style="display: none;">
                <button class="backup-btn" id="fazerBackup">ğŸ’¾ Backup</button>
                <button class="backup-btn" id="restaurarBackup">ğŸ“‚ Restaurar</button>
                <input type="file" id="arquivoBackup" accept=".enc" style="display: none;">
                <div class="theme-toggle" id="themeToggle">
                    <button class="theme-btn active" data-theme="dark">DARK</button>
                    <button class="theme-btn" data-theme="light">LIGHT</button>
                </div>
            </div>
        </div>

        <!-- Linha do botÃ£o LanÃ§ar Trade e seletor de contas -->
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; justify-content: space-between;">
            <div class="conta-selector" style="flex: 1;">
                <select id="contaSelect"></select>
            </div>
            <button class="launch-btn" id="lancarTradeBtn">ğŸš€ LanÃ§ar Trade</button>
        </div>

        <!-- cards mÃ©tricas da conta -->
        <div class="metric-grid">
            <div class="card"><div class="card-label">ğŸ’° Saldo inicial</div><div class="card-value" id="saldoInicial">U$ 5.000,00</div></div>
            <div class="card" id="metaCard">
                <div class="card-label">
                    ğŸ¯ Meta <span id="metaPercentLabel">10%</span>
                    <span id="metaStatusText">(falta)</span>
                </div>
                <div class="card-value" id="metaFalta">U$ 565,98</div>
                <div class="progress-meta" id="progressMeta">â¬†ï¸ Faltam 11.3% para 10%</div>
            </div>
            <div class="card"><div class="card-label">ğŸ“‰ Drawdown MÃ¡x <span id="ddMaxLabel">7%</span></div><div class="card-value" id="ddMax">1.9%</div><div class="badge" id="ddMaxStatus">seguro</div></div>
            <div class="card"><div class="card-label">âœ… Positivos (lÃ­quido)</div><div class="card-value" id="totalPos">1</div></div>
            <div class="card"><div class="card-label">âŒ Negativos (lÃ­quido)</div><div class="card-value" id="totalNeg">4</div></div>
        </div>

        <!-- divisor + mÃ©tricas diÃ¡rias -->
        <div class="divider"></div>
        <div style="display: flex; flex-wrap: wrap; gap: 1.2rem; align-items: baseline; margin-bottom: 1rem;">
            <span class="badge" style="font-size: 1rem;">ğŸ“… trades hoje: <strong id="tradesHoje">2</strong></span>
            <span class="badge" id="dailyDrawdownBadge" style="background: var(--danger-bg);">ğŸ“‰ Drawdown diÃ¡rio: <strong id="ddDiario">0%</strong> / <span id="ddDiarioLimite">2%</span></span>
            <span class="badge" style="background: var(--success-bg);">ğŸ“ˆ Positivos hoje: <strong id="posHoje">0</strong></span>
            <span class="badge" style="background: var(--danger-bg);">ğŸ“‰ Negativos hoje: <strong id="negHoje">2</strong></span>
            <span class="badge" style="background: var(--surface);">ğŸ’° Saldo atual: <strong id="saldoAtual">U$ 4.934,02</strong></span>
        </div>

        <!-- Indicadores do MT5 -->
        <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin: 1rem 0; padding: 0.5rem; background: var(--surface); border-radius: 2rem; justify-content: center;">
            <span class="badge" style="background: var(--bg-card);">ğŸ“‰ Lucro LÃ­quido Total: <strong id="lucroLiquidoTotal">-65.98</strong></span>
            <span class="badge" style="background: var(--bg-card);">ğŸ“ˆ Lucro Bruto: <strong id="lucroBrutoTotal">31.30</strong></span>
            <span class="badge" style="background: var(--bg-card);">ğŸ“‰ Perda Bruta: <strong id="perdaBrutaTotal">-97.28</strong></span>
            <span class="badge" style="background: var(--bg-card);">ğŸ“Š Fator de Lucro: <strong id="fatorLucro">0.32</strong></span>
            <span class="badge" style="background: var(--bg-card);">ğŸ“Š Retorno Esperado (Payoff): <strong id="retornoEsperado">-13.20</strong></span>
            <span class="badge" style="background: var(--bg-card);">ğŸ“Š Fator de RecuperaÃ§Ã£o: <strong id="fatorRecuperacao">-0.68</strong></span>
            <span class="badge" style="background: var(--bg-card);">ğŸ“Š Ãndice de Sharpe: <strong id="indiceSharpe">-0.44</strong></span>
        </div>

        <!-- FILTROS AVANÃ‡ADOS -->
        <div class="filter-bar">
            <div class="filter-item">
                <label>PerÃ­odo:</label>
                <select id="filtroPeriodo">
                    <option value="hoje">Hoje</option>
                    <option value="semana">Esta semana</option>
                    <option value="mes">Este mÃªs</option>
                    <option value="periodo">Personalizado</option>
                    <option value="todos">Todos</option>
                </select>
            </div>
            <div class="filter-item" id="dataInicioGroup" style="display: none;">
                <label>De:</label>
                <input type="date" id="dataInicio">
            </div>
            <div class="filter-item" id="dataFimGroup" style="display: none;">
                <label>AtÃ©:</label>
                <input type="date" id="dataFim">
            </div>
            <div class="filter-item">
                <label>Status:</label>
                <select id="filtroStatus">
                    <option value="todos">Todos</option>
                    <option value="abertos">Abertos</option>
                    <option value="fechados">Fechados</option>
                    <option value="positivos">Positivos</option>
                    <option value="negativos">Negativos</option>
                </select>
            </div>
            <button class="btn-outline" id="aplicarFiltro">Aplicar</button>
            <button class="btn-print" id="imprimirLista">ğŸ–¨ï¸ Imprimir</button>
        </div>

        <!-- Lista de trades com filtro -->
        <div style="margin: 1.5rem 0 0.5rem; display: flex; justify-content: space-between; align-items: center;">
            <span class="section-title" style="font-size: 1.2rem;">ğŸ“‹ Trades <span id="filtroDescricao">(todos)</span></span>
        </div>
        <div class="trades-list" id="tradesList"></div>
    </div>

    <script>
        (function() {
            // ========== TEMA ==========
            const themeBtns = document.querySelectorAll('.theme-btn');
            const body = document.body;
            const savedTheme = localStorage.getItem('traderTheme') || 'dark';
            body.classList.toggle('light-theme', savedTheme === 'light');
            themeBtns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === savedTheme);
            });
            themeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const theme = btn.dataset.theme;
                    body.classList.toggle('light-theme', theme === 'light');
                    localStorage.setItem('traderTheme', theme);
                    themeBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });

            // ========== CONFIGURAÃ‡ÃƒO DO INDEXEDDB ==========
            const DB_NAME = 'TraderDiarioDB';
            const DB_VERSION = 3;
            const STORE_NAME = 'contas';

            let db = null;
            let dbReady = false;
            let contas = [];
            let contaAtual = null;
            let config = {
                saldoInicial: 5000,
                metaPercent: 10,
                ddTipo: 'estatico',
                ddMax: 7,
                ddDiarioLimite: 2
            };
            let trades = [];

            // Elementos DOM
            const saldoInicialEl = document.getElementById('saldoInicial');
            const metaFaltaEl = document.getElementById('metaFalta');
            const progressMetaEl = document.getElementById('progressMeta');
            const ddMaxEl = document.getElementById('ddMax');
            const ddMaxStatus = document.getElementById('ddMaxStatus');
            const totalPosEl = document.getElementById('totalPos');
            const totalNegEl = document.getElementById('totalNeg');
            const tradesHojeEl = document.getElementById('tradesHoje');
            const ddDiarioEl = document.getElementById('ddDiario');
            const posHojeEl = document.getElementById('posHoje');
            const negHojeEl = document.getElementById('negHoje');
            const saldoAtualEl = document.getElementById('saldoAtual');
            const filtroPeriodoSelect = document.getElementById('filtroPeriodo');
            const filtroStatusSelect = document.getElementById('filtroStatus');
            const dataInicioGroup = document.getElementById('dataInicioGroup');
            const dataFimGroup = document.getElementById('dataFimGroup');
            const dataInicio = document.getElementById('dataInicio');
            const dataFim = document.getElementById('dataFim');
            const filtroDescricao = document.getElementById('filtroDescricao');
            const metaCard = document.getElementById('metaCard');
            const metaStatusText = document.getElementById('metaStatusText');
            const metaPercentLabel = document.getElementById('metaPercentLabel');
            const dailyDrawdownBadge = document.getElementById('dailyDrawdownBadge');
            const contaSelect = document.getElementById('contaSelect');

            // Elementos para os indicadores
            const lucroLiquidoTotalEl = document.getElementById('lucroLiquidoTotal');
            const lucroBrutoTotalEl = document.getElementById('lucroBrutoTotal');
            const perdaBrutaTotalEl = document.getElementById('perdaBrutaTotal');
            const fatorLucroEl = document.getElementById('fatorLucro');
            const retornoEsperadoEl = document.getElementById('retornoEsperado');
            const fatorRecuperacaoEl = document.getElementById('fatorRecuperacao');
            const indiceSharpeEl = document.getElementById('indiceSharpe');

            // ========== FUNÃ‡ÃƒO AUXILIAR PARA FORMATAR MOEDA ==========
            function formatarMoeda(valor) {
                if (valor === null || valor === undefined || isNaN(valor)) return 'U$ 0,00';
                let valorStr = valor.toFixed(2);
                let partes = valorStr.split('.');
                let inteiro = partes[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                return `U$ ${inteiro},${partes[1]}`;
            }

            // ========== FUNÃ‡Ã•ES DE INICIALIZAÃ‡ÃƒO DO BANCO ==========
            function abrirBanco() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onerror = (event) => {
                        console.error('Erro ao abrir IndexedDB', event.target.error);
                        reject(event.target.error);
                    };
                    request.onsuccess = (event) => {
                        db = event.target.result;
                        console.log('Banco aberto com sucesso');
                        dbReady = true;
                        resolve(db);
                    };
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            const store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                            store.createIndex('nome', 'nome', { unique: false });
                        } else {
                            const transaction = event.target.transaction;
                            const store = transaction.objectStore(STORE_NAME);
                            store.openCursor().onsuccess = (e) => {
                                const cursor = e.target.result;
                                if (cursor) {
                                    const conta = cursor.value;
                                    let modificado = false;
                                    if (!conta.resumoMT5) {
                                        conta.resumoMT5 = null;
                                        modificado = true;
                                    }
                                    if (conta.trades) {
                                        conta.trades.forEach(t => {
                                            if (t.lucroBruto === undefined) {
                                                t.lucroBruto = t.valor || 0;
                                                t.comissao = 0;
                                                t.swap = 0;
                                                t.positionId = t.positionId || null;
                                                modificado = true;
                                            }
                                        });
                                    }
                                    if (modificado) {
                                        cursor.update(conta);
                                    }
                                    cursor.continue();
                                }
                            };
                        }
                        console.log('Banco atualizado/criado');
                    };
                });
            }

            async function carregarContas() {
                if (!db) return;
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.getAll();
                    request.onsuccess = () => {
                        contas = request.result;
                        atualizarSelectContas();
                        resolve(contas);
                    };
                    request.onerror = (e) => reject(e.target.error);
                });
            }

            function atualizarSelectContas() {
                contaSelect.innerHTML = '';
                contas.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = c.nome;
                    contaSelect.appendChild(option);
                });
                if (contaAtual) {
                    const existe = contas.some(c => c.id === contaAtual.id);
                    if (existe) {
                        contaSelect.value = contaAtual.id;
                    } else if (contas.length > 0) {
                        contaSelect.value = contas[0].id;
                        carregarContaPorId(contas[0].id);
                    }
                } else if (contas.length > 0) {
                    contaSelect.value = contas[0].id;
                    carregarContaPorId(contas[0].id);
                }
            }

            async function carregarContaPorId(id) {
                if (!db) return;
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.get(id);
                    request.onsuccess = () => {
                        const conta = request.result;
                        if (conta) {
                            contaAtual = conta;
                            trades = conta.trades || [];
                            config.saldoInicial = conta.saldoInicial;
                            config.metaPercent = conta.metaPercent;
                            config.ddTipo = conta.ddTipo;
                            config.ddMax = conta.ddMax;
                            config.ddDiarioLimite = conta.ddDiarioLimite;
                            localStorage.setItem('ultimaContaId', id);
                            atualizarSelectContas();
                            atualizarLabelsConfig();
                            renderTrades();
                            atualizarMetricas();
                            console.log('Conta carregada:', id, conta.nome);
                        } else {
                            console.warn('Conta nÃ£o encontrada com id:', id);
                        }
                        resolve(conta);
                    };
                    request.onerror = (e) => reject(e.target.error);
                });
            }

            async function salvarConta(conta) {
                if (!db) return;
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    let request;
                    if (conta.id) {
                        request = store.put(conta);
                    } else {
                        request = store.add(conta);
                    }
                    request.onsuccess = (event) => {
                        if (!conta.id) {
                            conta.id = event.target.result;
                        }
                        carregarContas().then(() => resolve(conta));
                    };
                    request.onerror = (e) => reject(e.target.error);
                });
            }

            async function excluirContaPorId(id) {
                if (!db) return;
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.delete(id);
                    request.onsuccess = () => {
                        carregarContas().then(resolve);
                    };
                    request.onerror = (e) => reject(e.target.error);
                });
            }

            // ========== FUNÃ‡Ã•ES AUXILIARES ==========
            function getLocalDateString() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            function getCurrentDateTime() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            }

            function getFormatConfig(par) {
                const formatos = {
                    'EURUSD': { decimals: 5, step: 0.00001 },
                    'USDCHF': { decimals: 5, step: 0.00001 },
                    'GBPUSD': { decimals: 5, step: 0.00001 },
                    'NZDUSD': { decimals: 5, step: 0.00001 },
                    'AUDUSD': { decimals: 5, step: 0.00001 },
                    'USDCAD': { decimals: 5, step: 0.00001 },
                    'CADUSD': { decimals: 5, step: 0.00001 },
                    'USDJPY': { decimals: 3, step: 0.001 },
                    'XAUUSD': { decimals: 2, step: 0.01 },
                    'XAGUSD': { decimals: 3, step: 0.001 },
                    'BTCUSD': { decimals: 2, step: 0.01 },
                    'ETHUSD': { decimals: 2, step: 0.01 }
                };
                return formatos[par] || { decimals: 5, step: 0.00001 };
            }

            function formatPriceValue(value, par) {
                if (value === '' || value === null || isNaN(value)) return '';
                const conf = getFormatConfig(par);
                return Number(value).toFixed(conf.decimals);
            }

            // ========== FUNÃ‡Ã•ES DE INTERFACE ==========
            function atualizarLabelsConfig() {
                document.getElementById('metaPercentLabel').innerText = config.metaPercent + '%';
                document.getElementById('ddMaxLabel').innerText = config.ddMax + '%';
                document.getElementById('ddDiarioLimite').innerText = config.ddDiarioLimite + '%';
            }

            function obterIndicadores() {
                if (contaAtual && contaAtual.resumoMT5) {
                    return contaAtual.resumoMT5;
                }
                const tradesFechados = trades.filter(t => t.fechadoCom);
                if (tradesFechados.length === 0) {
                    return {
                        lucroLiquido: 0,
                        lucroBruto: 0,
                        perdaBruta: 0,
                        fatorLucro: 0,
                        retornoEsperado: 0,
                        fatorRecuperacao: 0,
                        sharpe: 0
                    };
                }

                const lucroLiquido = tradesFechados.reduce((acc, t) => acc + (t.valor || 0), 0);
                const lucroBruto = tradesFechados.reduce((acc, t) => acc + (t.lucroBruto > 0 ? t.lucroBruto : 0), 0);
                const perdaBruta = tradesFechados.reduce((acc, t) => acc + (t.lucroBruto < 0 ? t.lucroBruto : 0), 0);
                const fatorLucro = perdaBruta !== 0 ? (lucroBruto / Math.abs(perdaBruta)) : (lucroBruto > 0 ? Infinity : 0);
                const retornoEsperado = lucroLiquido / tradesFechados.length;

                let saldo = config.saldoInicial;
                let pico = saldo;
                let maxDrawdownValor = 0;
                const tradesOrdenados = [...tradesFechados].sort((a, b) => new Date(a.dataEntrada) - new Date(b.dataEntrada));
                tradesOrdenados.forEach(t => {
                    saldo += t.valor || 0;
                    if (saldo > pico) pico = saldo;
                    const drawdown = pico - saldo;
                    if (drawdown > maxDrawdownValor) maxDrawdownValor = drawdown;
                });
                const fatorRecuperacao = maxDrawdownValor !== 0 ? (lucroLiquido / maxDrawdownValor) : 0;

                const retornos = tradesFechados.map(t => t.valor || 0);
                const media = lucroLiquido / retornos.length;
                const somaQuadrados = retornos.reduce((acc, r) => acc + Math.pow(r - media, 2), 0);
                const desvioPadrao = Math.sqrt(somaQuadrados / retornos.length) || 1;
                const sharpe = media / desvioPadrao;

                return {
                    lucroLiquido,
                    lucroBruto,
                    perdaBruta,
                    fatorLucro,
                    retornoEsperado,
                    fatorRecuperacao,
                    sharpe
                };
            }

            function atualizarMetricas() {
                if (!contaAtual) return;
                let totalPos = 0, totalNeg = 0, tradesHoje = 0, posHoje = 0, negHoje = 0;
                const hojeStr = getLocalDateString();

                trades.forEach(t => {
                    const liquido = t.valor || 0;
                    if (liquido > 0) totalPos++;
                    else if (liquido < 0) totalNeg++;

                    if (t.dataEntrada && t.dataEntrada.slice(0,10) === hojeStr) {
                        tradesHoje++;
                        if (liquido > 0) posHoje++;
                        else if (liquido < 0) negHoje++;
                    }
                });

                let somaValores = 0;
                trades.forEach(t => {
                    somaValores += t.valor || 0;
                });
                const saldoAtual = config.saldoInicial + somaValores;

                const metaValor = config.saldoInicial * (config.metaPercent / 100);
                const lucroAtual = saldoAtual - config.saldoInicial;
                const faltaMeta = Math.max(0, metaValor - lucroAtual);
                const percentFalta = (faltaMeta / config.saldoInicial) * 100;

                const metaAtingida = lucroAtual >= metaValor;
                if (metaAtingida) {
                    metaStatusText.innerText = 'âœ…';
                    metaStatusText.style.color = 'var(--success)';
                    metaFaltaEl.innerText = formatarMoeda(0);
                    metaFaltaEl.style.color = 'var(--success)';
                    progressMetaEl.innerText = 'ğŸ‰ Meta atingida!';
                    progressMetaEl.style.color = 'var(--success)';
                    metaCard.classList.add('meta-atingida');
                } else {
                    metaStatusText.innerText = '(falta)';
                    metaStatusText.style.color = '';
                    metaFaltaEl.innerText = formatarMoeda(faltaMeta);
                    metaFaltaEl.style.color = '';
                    progressMetaEl.innerText = `â¬†ï¸ Faltam ${percentFalta.toFixed(1)}% para ${config.metaPercent}%`;
                    progressMetaEl.style.color = '';
                    metaCard.classList.remove('meta-atingida');
                }

                let ddExibido = 0;
                if (config.ddTipo === 'estatico') {
                    const perdaAtual = config.saldoInicial - saldoAtual;
                    ddExibido = perdaAtual > 0 ? (perdaAtual / config.saldoInicial) * 100 : 0;
                } else {
                    const tradesOrdenados = [...trades].sort((a, b) => new Date(a.dataEntrada) - new Date(b.dataEntrada));
                    let pico = config.saldoInicial;
                    let saldoCorrente = config.saldoInicial;
                    let maxQueda = 0;
                    tradesOrdenados.forEach(t => {
                        saldoCorrente += t.valor || 0;
                        if (saldoCorrente > pico) pico = saldoCorrente;
                        const queda = (pico - saldoCorrente) / pico * 100;
                        if (queda > maxQueda) maxQueda = queda;
                    });
                    ddExibido = maxQueda;
                }

                const ddExibidoFixed = ddExibido.toFixed(1);
                const ddMaxAtingido = parseFloat(ddExibidoFixed) >= config.ddMax;
                ddMaxStatus.innerText = ddMaxAtingido ? 'âš ï¸ ATENÃ‡ÃƒO' : 'seguro';
                ddMaxStatus.style.color = ddMaxAtingido ? 'var(--danger)' : 'var(--success)';
                ddMaxEl.innerText = ddExibido > 0 ? `${ddExibidoFixed}%` : '0%';

                const saldoAberturaHoje = config.saldoInicial + trades.filter(t => t.dataEntrada && t.dataEntrada.slice(0,10) < hojeStr).reduce((acc, t) => acc + (t.valor || 0), 0);

                const tradesHojeOrdenados = trades
                    .filter(t => t.dataEntrada && t.dataEntrada.slice(0,10) === hojeStr)
                    .sort((a, b) => new Date(a.dataEntrada) - new Date(b.dataEntrada));

                let saldoCorrenteDia = saldoAberturaHoje;
                let menorSaldoDia = saldoAberturaHoje;
                tradesHojeOrdenados.forEach(t => {
                    saldoCorrenteDia += t.valor || 0;
                    if (saldoCorrenteDia < menorSaldoDia) menorSaldoDia = saldoCorrenteDia;
                });

                const ddDiarioPercent = menorSaldoDia < saldoAberturaHoje ? ((saldoAberturaHoje - menorSaldoDia) / saldoAberturaHoje) * 100 : 0;

                saldoInicialEl.innerText = formatarMoeda(config.saldoInicial);
                totalPosEl.innerText = totalPos;
                totalNegEl.innerText = totalNeg;
                tradesHojeEl.innerText = tradesHoje;
                
                const limiteAtingido = ddDiarioPercent >= config.ddDiarioLimite;
                if (limiteAtingido) {
                    ddDiarioEl.innerHTML = `âš ï¸ -${ddDiarioPercent.toFixed(1)}%`;
                    dailyDrawdownBadge.classList.add('danger-atingido');
                } else {
                    ddDiarioEl.innerText = ddDiarioPercent > 0 ? `-${ddDiarioPercent.toFixed(1)}%` : '0%';
                    dailyDrawdownBadge.classList.remove('danger-atingido');
                }
                ddDiarioEl.style.color = limiteAtingido ? 'var(--danger)' : 'inherit';
                
                posHojeEl.innerText = posHoje;
                negHojeEl.innerText = negHoje;
                saldoAtualEl.innerText = formatarMoeda(saldoAtual);

                const indicadores = obterIndicadores();
                lucroLiquidoTotalEl.innerText = indicadores.lucroLiquido.toFixed(2);
                lucroBrutoTotalEl.innerText = indicadores.lucroBruto.toFixed(2);
                perdaBrutaTotalEl.innerText = indicadores.perdaBruta.toFixed(2);
                fatorLucroEl.innerText = indicadores.fatorLucro.toFixed(2);
                retornoEsperadoEl.innerText = indicadores.retornoEsperado.toFixed(2);
                fatorRecuperacaoEl.innerText = indicadores.fatorRecuperacao.toFixed(2);
                indiceSharpeEl.innerText = indicadores.sharpe.toFixed(2);
            }

            // ========== FILTROS ==========
            let filtroPeriodo = 'hoje';
            let filtroStatus = 'todos';
            let dataInicioFiltro = '';
            let dataFimFiltro = '';

            filtroPeriodoSelect.addEventListener('change', () => {
                const val = filtroPeriodoSelect.value;
                if (val === 'periodo') {
                    dataInicioGroup.style.display = 'flex';
                    dataFimGroup.style.display = 'flex';
                } else {
                    dataInicioGroup.style.display = 'none';
                    dataFimGroup.style.display = 'none';
                }
            });

            document.getElementById('aplicarFiltro').addEventListener('click', () => {
                filtroPeriodo = filtroPeriodoSelect.value;
                filtroStatus = filtroStatusSelect.value;
                if (filtroPeriodo === 'periodo') {
                    dataInicioFiltro = dataInicio.value;
                    dataFimFiltro = dataFim.value;
                }
                renderTrades();
                Swal.fire({
                    icon: 'info',
                    title: 'Filtro aplicado',
                    timer: 1000,
                    showConfirmButton: false
                });
            });

            function filtrarTrades() {
                let lista = trades;

                if (filtroPeriodo !== 'todos') {
                    const hoje = new Date();
                    let inicio, fim;

                    if (filtroPeriodo === 'hoje') {
                        inicio = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
                        fim = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate(), 23, 59, 59);
                    } else if (filtroPeriodo === 'semana') {
                        const diaSemana = hoje.getDay();
                        inicio = new Date(hoje);
                        inicio.setDate(hoje.getDate() - diaSemana + (diaSemana === 0 ? -6 : 1));
                        fim = new Date(inicio);
                        fim.setDate(inicio.getDate() + 6);
                    } else if (filtroPeriodo === 'mes') {
                        inicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                        fim = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
                    } else if (filtroPeriodo === 'periodo') {
                        if (!dataInicioFiltro || !dataFimFiltro) return lista;
                        inicio = new Date(dataInicioFiltro + 'T00:00:00');
                        fim = new Date(dataFimFiltro + 'T23:59:59');
                    }

                    if (inicio && fim) {
                        lista = lista.filter(t => {
                            if (!t.dataEntrada) return false;
                            const dataTrade = new Date(t.dataEntrada);
                            return dataTrade >= inicio && dataTrade <= fim;
                        });
                    }
                }

                if (filtroStatus !== 'todos') {
                    lista = lista.filter(t => {
                        if (filtroStatus === 'abertos') return !t.fechadoCom;
                        if (filtroStatus === 'fechados') return t.fechadoCom;
                        if (filtroStatus === 'positivos') return t.valor > 0;
                        if (filtroStatus === 'negativos') return t.valor < 0;
                        return true;
                    });
                }

                let descricao = [];
                if (filtroPeriodo === 'hoje') descricao.push('hoje');
                else if (filtroPeriodo === 'semana') descricao.push('esta semana');
                else if (filtroPeriodo === 'mes') descricao.push('este mÃªs');
                else if (filtroPeriodo === 'periodo') descricao.push('perÃ­odo');
                
                if (filtroStatus !== 'todos') {
                    descricao.push(filtroStatus);
                }
                
                filtroDescricao.innerText = descricao.length ? '(' + descricao.join(', ') + ')' : '(todos)';

                return lista;
            }

            function renderTrades() {
                const listaFiltrada = filtrarTrades();
                // Ordenar por data decrescente (mais recente primeiro)
                listaFiltrada.sort((a, b) => new Date(b.dataEntrada) - new Date(a.dataEntrada));
                
                const container = document.getElementById('tradesList');
                container.innerHTML = '';

                listaFiltrada.forEach((t, idx) => {
                    const isAberto = !t.fechadoCom || t.fechadoCom === '';
                    const item = document.createElement('div');
                    item.className = 'trade-item';
                    
                    let sentimentosHtml = '';
                    if (t.sentimentoAbertura || t.sentimentoFechamento) {
                        sentimentosHtml = `<small style="color: var(--text-secondary);">ğŸ˜Š ${t.sentimentoAbertura || ''} ${t.sentimentoFechamento ? 'â†’ '+t.sentimentoFechamento : ''}</small>`;
                    }

                    // Mostrar o lucro bruto
                    const valorBruto = t.lucroBruto || 0;
                    const sinal = valorBruto > 0 ? 'âœ…' : (valorBruto < 0 ? 'âŒ' : 'âšª');
                    const valorFormatado = formatarMoeda(Math.abs(valorBruto));

                    item.innerHTML = `
                        <div class="trade-info">
                            <span>ğŸ”¹ ${t.moeda || '---'}</span>
                            <span>${t.dataEntrada ? t.dataEntrada.replace('T',' ') : '--'}</span>
                            <span class="badge" style="background:${t.tipoEntrada==='Compra'?'var(--success-bg)':'var(--danger-bg)'};color:${t.tipoEntrada==='Compra'?'var(--success)':'var(--danger)'}">${t.tipoEntrada || ''}</span>
                            <span style="margin-left: 0.5rem; font-size:0.8rem;">ğŸ“Š Lote: ${t.lote || '0'}</span>
                            <span class="status-badge ${isAberto ? 'status-aberto' : 'status-fechado'}">${isAberto ? 'â³ Aberto' : 'âœ… Fechado'}</span>
                            ${sentimentosHtml}
                        </div>
                        <div class="trade-status">
                            ${!isAberto ? `<span>${sinal} ${valorFormatado}</span>` : ''}
                            <button class="btn-info" data-id="${t.id}" data-action="editar">ğŸ‘ï¸ Editar/Ver</button>
                            ${isAberto ? `<button class="btn-success" data-id="${t.id}" data-action="fechar">ğŸ”’ Fechar</button>` : ''}
                            <button class="btn-danger" data-id="${t.id}" data-action="excluir">ğŸ—‘ï¸ Excluir</button>
                        </div>
                    `;
                    container.appendChild(item);
                });

                document.querySelectorAll('[data-action="excluir"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        Swal.fire({
                            title: 'Excluir trade?',
                            text: 'Esta aÃ§Ã£o nÃ£o poderÃ¡ ser desfeita.',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Sim, excluir',
                            cancelButtonText: 'Cancelar'
                        }).then(async (result) => {
                            if (result.isConfirmed) {
                                const index = trades.findIndex(t => t.id == id);
                                if (index !== -1) trades.splice(index, 1);
                                contaAtual.trades = trades;
                                contaAtual.resumoMT5 = null; // remove resumo para recalcular
                                await salvarConta(contaAtual);
                                renderTrades();
                                atualizarMetricas();
                                Swal.fire('ExcluÃ­do!', 'Trade removido.', 'success');
                            }
                        });
                    });
                });

                document.querySelectorAll('[data-action="editar"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        const trade = trades.find(t => t.id == id);
                        if (trade) {
                            const index = trades.findIndex(t => t.id == id);
                            abrirModalLancamento(trade, index);
                        }
                    });
                });

                document.querySelectorAll('[data-action="fechar"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        const trade = trades.find(t => t.id == id);
                        if (trade) {
                            const index = trades.findIndex(t => t.id == id);
                            abrirModalLancamento(trade, index);
                        }
                    });
                });
            }

            // ========== MODAL DE LANÃ‡AMENTO/EDIÃ‡ÃƒO (COMPLETO COM IMAGENS) ==========
            document.getElementById('lancarTradeBtn').addEventListener('click', () => {
                abrirModalLancamento();
            });

            function abrirModalLancamento(tradeParaEditar = null, indexParaEditar = -1) {
                const isEdicao = tradeParaEditar !== null;
                const now = getCurrentDateTime();
                
                const lucroBruto = isEdicao ? (tradeParaEditar.lucroBruto !== undefined ? tradeParaEditar.lucroBruto : tradeParaEditar.valor) : '';
                const comissao = isEdicao ? (tradeParaEditar.comissao !== undefined ? tradeParaEditar.comissao : 0) : '';
                const swap = isEdicao ? (tradeParaEditar.swap !== undefined ? tradeParaEditar.swap : 0) : '';

                const modalHtml = `
                    <div style="max-height: 70vh; overflow-y: auto; padding: 0.5rem;">
                        <div class="modal-field">
                            <label>Moeda</label>
                            <select id="modal-moeda">
                                <option value="EURUSD">EURUSD</option>
                                <option value="USDJPY">USDJPY</option>
                                <option value="GBPUSD">GBPUSD</option>
                                <option value="AUDUSD">AUDUSD</option>
                                <option value="USDCAD">USDCAD</option>
                                <option value="NZDUSD">NZDUSD</option>
                                <option value="USDCHF">USDCHF</option>
                                <option value="CADUSD">CADUSD</option>
                                <option value="XAUUSD">XAUUSD (ouro)</option>
                                <option value="XAGUSD">XAGUSD (prata)</option>
                                <option value="BTCUSD">BTCUSD</option>
                                <option value="ETHUSD">ETHUSD</option>
                            </select>
                        </div>
                        <div class="modal-field">
                            <label>Data/Hora Entrada</label>
                            <input type="datetime-local" id="modal-dataEntrada" value="${isEdicao ? tradeParaEditar.dataEntrada || now : now}">
                        </div>
                        <div class="modal-field">
                            <label>Tipo entrada</label>
                            <select id="modal-tipoEntrada">
                                <option value="Compra" ${isEdicao && tradeParaEditar.tipoEntrada === 'Compra' ? 'selected' : ''}>Compra (Long)</option>
                                <option value="Venda" ${isEdicao && tradeParaEditar.tipoEntrada === 'Venda' ? 'selected' : ''}>Venda (Short)</option>
                            </select>
                        </div>
                        <div class="modal-row">
                            <div class="modal-field">
                                <label>PreÃ§o entrada</label>
                                <input type="number" step="any" id="modal-precoEntrada" placeholder="1.10520" value="${isEdicao ? tradeParaEditar.precoEntrada || '' : ''}">
                            </div>
                            <div class="modal-field">
                                <label>Stop Loss</label>
                                <input type="number" step="any" id="modal-stopLoss" placeholder="1.10000" value="${isEdicao ? tradeParaEditar.stopLoss || '' : ''}">
                            </div>
                        </div>
                        <div class="modal-row">
                            <div class="modal-field">
                                <label>Take Profit</label>
                                <input type="number" step="any" id="modal-takeProfit" placeholder="1.11000" value="${isEdicao ? tradeParaEditar.takeProfit || '' : ''}">
                            </div>
                            <div class="modal-field">
                                <label>Lote</label>
                                <input type="number" step="0.01" id="modal-lote" placeholder="Ex: 0.10" value="${isEdicao ? tradeParaEditar.lote || '' : ''}">
                            </div>
                        </div>
                        
                        <!-- Ãrea de imagem de entrada -->
                        <div class="modal-field">
                            <label>ğŸ“¸ Imagem Entrada</label>
                            <div class="modal-image-area">
                                <input type="text" id="modal-imgEntradaNome" readonly placeholder="Cole a imagem (Ctrl+V)" style="flex: 1; background: transparent; border: none;" value="${isEdicao && tradeParaEditar.imgEntradaNome ? tradeParaEditar.imgEntradaNome : ''}">
                                <img class="modal-image-preview" id="modal-previewEntrada" src="${isEdicao && tradeParaEditar.imgEntradaBase64 ? tradeParaEditar.imgEntradaBase64 : 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'40\' height=\'40\' viewBox=\'0 0 24 24\' fill=\'%233b82f6\'%3E%3Crect width=\'24\' height=\'24\' fill=\'%232a313e\'/%3E%3Ctext x=\'4\' y=\'17\' fill=\'%23fff\' font-size=\'10\'%3EğŸ“¸%3C/text%3E%3C/svg%3E'}" alt="preview">
                                <button class="clear-image-btn" id="modal-limparImgEntrada" type="button">ğŸ—‘ï¸</button>
                                <button class="zoom-image-btn" id="modal-zoomImgEntrada" type="button">ğŸ”</button>
                            </div>
                        </div>

                        <div class="modal-field">
                            <label>ObservaÃ§Ãµes abertura</label>
                            <textarea id="modal-obsAbertura" rows="2" placeholder="notas da entrada...">${isEdicao ? tradeParaEditar.obsAbertura || '' : ''}</textarea>
                        </div>

                        <div class="modal-field">
                            <label>ğŸ˜Š Sentimento na abertura</label>
                            <select id="modal-sentimentoAbertura">
                                <option value="">-- Selecione --</option>
                                <option value="ConfianÃ§a" ${isEdicao && tradeParaEditar.sentimentoAbertura === 'ConfianÃ§a' ? 'selected' : ''}>ConfianÃ§a</option>
                                <option value="Ansiedade" ${isEdicao && tradeParaEditar.sentimentoAbertura === 'Ansiedade' ? 'selected' : ''}>Ansiedade</option>
                                <option value="Neutro" ${isEdicao && tradeParaEditar.sentimentoAbertura === 'Neutro' ? 'selected' : ''}>Neutro</option>
                                <option value="Euforia" ${isEdicao && tradeParaEditar.sentimentoAbertura === 'Euforia' ? 'selected' : ''}>Euforia</option>
                                <option value="Medo" ${isEdicao && tradeParaEditar.sentimentoAbertura === 'Medo' ? 'selected' : ''}>Medo</option>
                                <option value="DÃºvida" ${isEdicao && tradeParaEditar.sentimentoAbertura === 'DÃºvida' ? 'selected' : ''}>DÃºvida</option>
                            </select>
                        </div>

                        <div style="border-left: 3px solid var(--accent); padding-left: 1rem; margin: 1rem 0;">
                            <span style="font-weight: 600;">ğŸ”’ Fechamento</span>
                        </div>

                        <!-- Campos de Lucro Bruto, ComissÃ£o, Swap -->
                        <div class="modal-row-3">
                            <div class="modal-field">
                                <label>Lucro Bruto (U$)</label>
                                <input type="number" step="0.01" id="modal-lucroBruto" placeholder="0.00" value="${lucroBruto}">
                            </div>
                            <div class="modal-field">
                                <label>ComissÃ£o (U$)</label>
                                <input type="number" step="0.01" id="modal-comissao" placeholder="0.00" value="${comissao}">
                            </div>
                            <div class="modal-field">
                                <label>Swap (U$)</label>
                                <input type="number" step="0.01" id="modal-swap" placeholder="0.00" value="${swap}">
                            </div>
                        </div>

                        <div class="modal-row-3">
                            <div class="modal-field">
                                <label>Fechado com</label>
                                <select id="modal-fechadoCom">
                                    <option value="">-- Selecione --</option>
                                    <option value="Lucro" ${isEdicao && tradeParaEditar.fechadoCom === 'Lucro' ? 'selected' : ''}>Lucro</option>
                                    <option value="Prejuizo" ${isEdicao && tradeParaEditar.fechadoCom === 'Prejuizo' ? 'selected' : ''}>PrejuÃ­zo</option>
                                </select>
                            </div>
                            <div class="modal-field">
                                <label>Data/Hora Fechamento</label>
                                <input type="datetime-local" id="modal-dataFechamento" value="${isEdicao ? tradeParaEditar.dataFechamento || '' : ''}">
                            </div>
                        </div>

                        <!-- Ãrea de imagem de fechamento -->
                        <div class="modal-field">
                            <label>ğŸ“¸ Imagem Fechamento</label>
                            <div class="modal-image-area">
                                <input type="text" id="modal-imgFechamentoNome" readonly placeholder="Cole a imagem (Ctrl+V)" style="flex: 1; background: transparent; border: none;" value="${isEdicao && tradeParaEditar.imgFechamentoNome ? tradeParaEditar.imgFechamentoNome : ''}">
                                <img class="modal-image-preview" id="modal-previewFechamento" src="${isEdicao && tradeParaEditar.imgFechamentoBase64 ? tradeParaEditar.imgFechamentoBase64 : 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'40\' height=\'40\' viewBox=\'0 0 24 24\' fill=\'%23ef4444\'%3E%3Crect width=\'24\' height=\'24\' fill=\'%232a313e\'/%3E%3Ctext x=\'4\' y=\'17\' fill=\'%23fff\' font-size=\'10\'%3EğŸ“¸%3C/text%3E%3C/svg%3E'}" alt="preview">
                                <button class="clear-image-btn" id="modal-limparImgFechamento" type="button">ğŸ—‘ï¸</button>
                                <button class="zoom-image-btn" id="modal-zoomImgFechamento" type="button">ğŸ”</button>
                            </div>
                        </div>

                        <div class="modal-field">
                            <label>ObservaÃ§Ãµes Fechamento</label>
                            <textarea id="modal-obsFechamento" rows="2">${isEdicao ? tradeParaEditar.obsFechamento || '' : ''}</textarea>
                        </div>

                        <div class="modal-field">
                            <label>ğŸ˜Š Sentimento no fechamento</label>
                            <select id="modal-sentimentoFechamento">
                                <option value="">-- Selecione --</option>
                                <option value="Realizado" ${isEdicao && tradeParaEditar.sentimentoFechamento === 'Realizado' ? 'selected' : ''}>Realizado</option>
                                <option value="AlÃ­vio" ${isEdicao && tradeParaEditar.sentimentoFechamento === 'AlÃ­vio' ? 'selected' : ''}>AlÃ­vio</option>
                                <option value="FrustraÃ§Ã£o" ${isEdicao && tradeParaEditar.sentimentoFechamento === 'FrustraÃ§Ã£o' ? 'selected' : ''}>FrustraÃ§Ã£o</option>
                                <option value="Orgulho" ${isEdicao && tradeParaEditar.sentimentoFechamento === 'Orgulho' ? 'selected' : ''}>Orgulho</option>
                                <option value="Arrependimento" ${isEdicao && tradeParaEditar.sentimentoFechamento === 'Arrependimento' ? 'selected' : ''}>Arrependimento</option>
                                <option value="Neutro" ${isEdicao && tradeParaEditar.sentimentoFechamento === 'Neutro' ? 'selected' : ''}>Neutro</option>
                            </select>
                        </div>

                        <div class="modal-actions">
                            <button class="modal-btn-outline" id="modal-cancelar">Cancelar</button>
                            <button class="modal-btn-print" id="modal-imprimir">ğŸ–¨ï¸ Imprimir</button>
                            <button class="modal-btn-primary" id="modal-salvar">ğŸ’¾ ${isEdicao ? 'Atualizar Trade' : 'Salvar Trade'}</button>
                        </div>
                    </div>
                `;

                Swal.fire({
                    title: isEdicao ? 'âœï¸ Editar Trade' : 'ğŸš€ LanÃ§ar Novo Trade',
                    html: modalHtml,
                    showConfirmButton: false,
                    showCancelButton: false,
                    background: 'var(--bg-card)',
                    color: 'var(--text-primary)',
                    width: '85%',
                    didOpen: () => {
                        const modalMoeda = document.getElementById('modal-moeda');
                        const modalPreco = document.getElementById('modal-precoEntrada');
                        const modalStop = document.getElementById('modal-stopLoss');
                        const modalTarget = document.getElementById('modal-takeProfit');
                        const modalLote = document.getElementById('modal-lote');
                        const modalPreviewEntrada = document.getElementById('modal-previewEntrada');
                        const modalPreviewFechamento = document.getElementById('modal-previewFechamento');
                        const modalImgEntradaNome = document.getElementById('modal-imgEntradaNome');
                        const modalImgFechamentoNome = document.getElementById('modal-imgFechamentoNome');
                        const zoomEntradaBtn = document.getElementById('modal-zoomImgEntrada');
                        const zoomFechamentoBtn = document.getElementById('modal-zoomImgFechamento');
                        const imprimirBtn = document.getElementById('modal-imprimir');
                        const modalLucroBruto = document.getElementById('modal-lucroBruto');
                        const modalComissao = document.getElementById('modal-comissao');
                        const modalSwap = document.getElementById('modal-swap');
                        const modalFechadoCom = document.getElementById('modal-fechadoCom');

                        // FunÃ§Ã£o para atualizar o campo fechadoCom base no lÃ­quido (nÃ£o exibido)
                        function atualizarFechadoCom() {
                            const bruto = parseFloat(modalLucroBruto.value) || 0;
                            const com = parseFloat(modalComissao.value) || 0;
                            const sw = parseFloat(modalSwap.value) || 0;
                            const liquido = bruto - com + sw; // comissao jÃ¡ negativa
                            if (liquido > 0) modalFechadoCom.value = 'Lucro';
                            else if (liquido < 0) modalFechadoCom.value = 'Prejuizo';
                            else modalFechadoCom.value = '';
                        }

                        modalLucroBruto.addEventListener('input', atualizarFechadoCom);
                        modalComissao.addEventListener('input', atualizarFechadoCom);
                        modalSwap.addEventListener('input', atualizarFechadoCom);

                        if (isEdicao) {
                            if (tradeParaEditar.imgEntradaBase64) {
                                modalPreviewEntrada.src = tradeParaEditar.imgEntradaBase64;
                                modalImgEntradaNome.value = tradeParaEditar.imgEntradaNome || 'print_entrada.png';
                                modalImgEntradaNome.dataset.base64 = tradeParaEditar.imgEntradaBase64;
                            }
                            if (tradeParaEditar.imgFechamentoBase64) {
                                modalPreviewFechamento.src = tradeParaEditar.imgFechamentoBase64;
                                modalImgFechamentoNome.value = tradeParaEditar.imgFechamentoNome || 'print_fechamento.png';
                                modalImgFechamentoNome.dataset.base64 = tradeParaEditar.imgFechamentoBase64;
                            }
                        }

                        if (isEdicao && tradeParaEditar.moeda) {
                            modalMoeda.value = tradeParaEditar.moeda;
                            modalMoeda.dispatchEvent(new Event('change'));
                        }

                        const currentModal = Swal.getPopup();

                        // Zoom entrada
                        zoomEntradaBtn.addEventListener('click', () => {
                            if (modalPreviewEntrada.src && !modalPreviewEntrada.src.startsWith('data:image/svg')) {
                                Swal.fire({
                                    imageUrl: modalPreviewEntrada.src,
                                    imageAlt: 'Imagem ampliada',
                                    width: '90%',
                                    padding: '1rem',
                                    background: 'var(--bg-card)',
                                    showConfirmButton: true,
                                    confirmButtonText: 'Fechar',
                                    willClose: () => {
                                        currentModal.style.display = 'flex';
                                    }
                                });
                            } else {
                                Swal.fire('Sem imagem', 'NÃ£o hÃ¡ imagem para ampliar.', 'info');
                            }
                        });

                        // Zoom fechamento
                        zoomFechamentoBtn.addEventListener('click', () => {
                            if (modalPreviewFechamento.src && !modalPreviewFechamento.src.startsWith('data:image/svg')) {
                                Swal.fire({
                                    imageUrl: modalPreviewFechamento.src,
                                    imageAlt: 'Imagem ampliada',
                                    width: '90%',
                                    padding: '1rem',
                                    background: 'var(--bg-card)',
                                    showConfirmButton: true,
                                    confirmButtonText: 'Fechar',
                                    willClose: () => {
                                        currentModal.style.display = 'flex';
                                    }
                                });
                            } else {
                                Swal.fire('Sem imagem', 'NÃ£o hÃ¡ imagem para ampliar.', 'info');
                            }
                        });

                        // BotÃ£o imprimir
                        imprimirBtn.addEventListener('click', () => {
                            const dados = {
                                moeda: modalMoeda.value,
                                dataEntrada: document.getElementById('modal-dataEntrada').value,
                                tipoEntrada: document.getElementById('modal-tipoEntrada').value,
                                precoEntrada: parseFloat(modalPreco.value) || null,
                                stopLoss: parseFloat(modalStop.value) || null,
                                takeProfit: parseFloat(modalTarget.value) || null,
                                lote: parseFloat(modalLote.value) || null,
                                obsAbertura: document.getElementById('modal-obsAbertura').value,
                                sentimentoAbertura: document.getElementById('modal-sentimentoAbertura').value || null,
                                fechadoCom: modalFechadoCom.value || null,
                                lucroBruto: parseFloat(modalLucroBruto.value) || 0,
                                comissao: parseFloat(modalComissao.value) || 0,
                                swap: parseFloat(modalSwap.value) || 0,
                                dataFechamento: document.getElementById('modal-dataFechamento').value || null,
                                obsFechamento: document.getElementById('modal-obsFechamento').value,
                                sentimentoFechamento: document.getElementById('modal-sentimentoFechamento').value || null,
                                imgEntradaBase64: modalImgEntradaNome.dataset.base64 || null,
                                imgEntradaNome: modalImgEntradaNome.value || null,
                                imgFechamentoBase64: modalImgFechamentoNome.dataset.base64 || null,
                                imgFechamentoNome: modalImgFechamentoNome.value || null
                            };
                            imprimirTrade(dados);
                        });

                        // FormataÃ§Ã£o de preÃ§os conforme moeda
                        function aplicarFormatacaoModal() {
                            const par = modalMoeda.value;
                            const conf = getFormatConfig(par);
                            
                            [modalPreco, modalStop, modalTarget].forEach(input => {
                                if (input) input.step = conf.step;
                            });
                        }

                        modalMoeda.addEventListener('change', aplicarFormatacaoModal);
                        
                        [modalPreco, modalStop, modalTarget].forEach(input => {
                            if (input) {
                                input.addEventListener('blur', () => {
                                    if (input.value) {
                                        input.value = formatPriceValue(input.value, modalMoeda.value);
                                    }
                                });
                            }
                        });

                        // Colar imagem (entrada)
                        function setupModalPaste(inputElement, previewElement) {
                            inputElement.addEventListener('paste', (e) => {
                                e.preventDefault();
                                const items = e.clipboardData.items;
                                for (let item of items) {
                                    if (item.type.indexOf('image') !== -1) {
                                        const blob = item.getAsFile();
                                        const reader = new FileReader();
                                        reader.onload = (event) => {
                                            previewElement.src = event.target.result;
                                            inputElement.value = `print_${Date.now()}.png`;
                                            inputElement.dataset.base64 = event.target.result;
                                        };
                                        reader.readAsDataURL(blob);
                                        break;
                                    }
                                }
                            });
                            inputElement.focus();
                        }

                        setupModalPaste(modalImgEntradaNome, modalPreviewEntrada);
                        setupModalPaste(modalImgFechamentoNome, modalPreviewFechamento);

                        // Limpar imagem entrada
                        document.getElementById('modal-limparImgEntrada').addEventListener('click', () => {
                            modalPreviewEntrada.src = 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'40\' height=\'40\' viewBox=\'0 0 24 24\' fill=\'%233b82f6\'%3E%3Crect width=\'24\' height=\'24\' fill=\'%232a313e\'/%3E%3Ctext x=\'4\' y=\'17\' fill=\'%23fff\' font-size=\'10\'%3EğŸ“¸%3C/text%3E%3C/svg%3E';
                            modalImgEntradaNome.value = '';
                            delete modalImgEntradaNome.dataset.base64;
                        });

                        // Limpar imagem fechamento
                        document.getElementById('modal-limparImgFechamento').addEventListener('click', () => {
                            modalPreviewFechamento.src = 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'40\' height=\'40\' viewBox=\'0 0 24 24\' fill=\'%23ef4444\'%3E%3Crect width=\'24\' height=\'24\' fill=\'%232a313e\'/%3E%3Ctext x=\'4\' y=\'17\' fill=\'%23fff\' font-size=\'10\'%3EğŸ“¸%3C/text%3E%3C/svg%3E';
                            modalImgFechamentoNome.value = '';
                            delete modalImgFechamentoNome.dataset.base64;
                        });

                        // Cancelar
                        document.getElementById('modal-cancelar').addEventListener('click', () => {
                            Swal.close();
                        });

                        // Salvar
                        document.getElementById('modal-salvar').addEventListener('click', async () => {
                            const moeda = modalMoeda.value;
                            const dataEntrada = document.getElementById('modal-dataEntrada').value;
                            const tipoEntrada = document.getElementById('modal-tipoEntrada').value;
                            const precoEntrada = parseFloat(modalPreco.value) || null;
                            const stopLoss = parseFloat(modalStop.value) || null;
                            const takeProfit = parseFloat(modalTarget.value) || null;
                            const lote = parseFloat(modalLote.value) || null;
                            const obsAbertura = document.getElementById('modal-obsAbertura').value;
                            const sentimentoAbertura = document.getElementById('modal-sentimentoAbertura').value || null;
                            const fechadoCom = modalFechadoCom.value || null;
                            const lucroBruto = parseFloat(modalLucroBruto.value) || 0;
                            const comissao = parseFloat(modalComissao.value) || 0;
                            const swap = parseFloat(modalSwap.value) || 0;
                            const dataFechamento = document.getElementById('modal-dataFechamento').value || null;
                            const obsFechamento = document.getElementById('modal-obsFechamento').value;
                            const sentimentoFechamento = document.getElementById('modal-sentimentoFechamento').value || null;
                            
                            let imgEntradaBase64 = modalImgEntradaNome.dataset.base64;
                            if (!imgEntradaBase64 && modalPreviewEntrada.src && !modalPreviewEntrada.src.startsWith('data:image/svg')) {
                                imgEntradaBase64 = modalPreviewEntrada.src;
                            }
                            let imgFechamentoBase64 = modalImgFechamentoNome.dataset.base64;
                            if (!imgFechamentoBase64 && modalPreviewFechamento.src && !modalPreviewFechamento.src.startsWith('data:image/svg')) {
                                imgFechamentoBase64 = modalPreviewFechamento.src;
                            }

                            const imgEntradaNome = modalImgEntradaNome.value || null;
                            const imgFechamentoNome = modalImgFechamentoNome.value || null;

                            if (!moeda || !dataEntrada || !tipoEntrada) {
                                Swal.fire('Campos obrigatÃ³rios', 'Moeda, Data/Hora e Tipo sÃ£o obrigatÃ³rios.', 'warning');
                                return;
                            }

                            const valorLiquido = lucroBruto - comissao + swap; // comissao jÃ¡ negativa

                            const trade = {
                                id: isEdicao ? tradeParaEditar.id : Date.now() + Math.random(),
                                moeda, dataEntrada, tipoEntrada, precoEntrada, stopLoss, takeProfit, lote,
                                obsAbertura, sentimentoAbertura, fechadoCom, 
                                lucroBruto, comissao, swap,
                                valor: valorLiquido,
                                dataFechamento,
                                obsFechamento, sentimentoFechamento,
                                imgEntradaBase64, imgEntradaNome,
                                imgFechamentoBase64, imgFechamentoNome,
                                positionId: tradeParaEditar?.positionId || null
                            };

                            if (isEdicao) {
                                trades[indexParaEditar] = trade;
                            } else {
                                trades.push(trade);
                            }
                            contaAtual.trades = trades;
                            contaAtual.resumoMT5 = null; // remove resumo para recalcular
                            await salvarConta(contaAtual);

                            renderTrades();
                            atualizarMetricas();
                            Swal.close();
                            Swal.fire('Sucesso!', isEdicao ? 'Trade atualizado.' : 'Novo trade lanÃ§ado.', 'success');
                        });

                        aplicarFormatacaoModal();
                        if (isEdicao && tradeParaEditar.precoEntrada) {
                            modalPreco.value = formatPriceValue(tradeParaEditar.precoEntrada, tradeParaEditar.moeda);
                        }
                        if (isEdicao && tradeParaEditar.stopLoss) {
                            modalStop.value = formatPriceValue(tradeParaEditar.stopLoss, tradeParaEditar.moeda);
                        }
                        if (isEdicao && tradeParaEditar.takeProfit) {
                            modalTarget.value = formatPriceValue(tradeParaEditar.takeProfit, tradeParaEditar.moeda);
                        }

                        atualizarFechadoCom();
                    }
                });
            }

            function imprimirTrade(dados) {
                const agora = new Date();
                const dia = String(agora.getDate()).padStart(2, '0');
                const mes = String(agora.getMonth() + 1).padStart(2, '0');
                const ano = agora.getFullYear();
                const horas = String(agora.getHours()).padStart(2, '0');
                const minutos = String(agora.getMinutes()).padStart(2, '0');
                const dataHoraStr = `${dia}/${mes}/${ano}-${horas}:${minutos}hs`;
                
                const resultado = dados.fechadoCom || 'Aberto';
                const tituloRelatorio = `${dados.moeda}-${dados.tipoEntrada}-${resultado}-${dataHoraStr}`;

                const estilo = `
                    <style>
                        body { font-family: 'Inter', sans-serif; padding: 0.8rem; color: #000; background: #fff; font-size: 12px; }
                        h1 { color: #2563eb; margin-bottom: 0.5rem; font-size: 1.5rem; }
                        h2 { color: #1e293b; margin-top: 0.8rem; margin-bottom: 0.3rem; border-bottom: 1px solid #2563eb; padding-bottom: 0.2rem; font-size: 1.2rem; }
                        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.3rem 1rem; margin-top: 0.3rem; }
                        .info-label { font-weight: 600; color: #4b5563; text-transform: uppercase; font-size: 0.7rem; }
                        .info-value { font-size: 0.9rem; }
                        .image-box { margin-top: 0.5rem; margin-bottom: 0.5rem; }
                        .image-box img { max-width: 100%; max-height: 200px; height: auto; border: 1px solid #d1d5db; border-radius: 0.3rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                        .observacao { background: #f3f4f6; padding: 0.4rem; border-radius: 0.3rem; margin-top: 0.3rem; margin-bottom: 0.5rem; font-size: 0.9rem; }
                        .footer { margin-top: 0.8rem; text-align: right; color: #6b7280; font-size: 0.7rem; }
                    </style>
                `;

                const status = !dados.fechadoCom ? 'Aberto' : (dados.fechadoCom === 'Lucro' ? 'âœ… Lucro' : 'âŒ PrejuÃ­zo');
                const liquido = (dados.lucroBruto || 0) - (dados.comissao || 0) + (dados.swap || 0);
                const valorFormatado = formatarMoeda(liquido);
                const dataEntradaFormatada = dados.dataEntrada ? dados.dataEntrada.replace('T', ' ') : '-';
                const dataFechamentoFormatada = dados.dataFechamento ? dados.dataFechamento.replace('T', ' ') : '-';

                const html = `
                    <!DOCTYPE html>
                    <html>
                    <head><title>${tituloRelatorio}</title>${estilo}</head>
                    <body>
                        <h1>ğŸ“Š Detalhe do Trade</h1>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem;">
                            <p><strong>Par:</strong> ${dados.moeda || '-'}</p>
                            <p><strong>Status:</strong> ${status}</p>
                        </div>

                        <h2>Entrada</h2>
                        <div class="info-grid">
                            <div><span class="info-label">Data/Hora:</span> <span class="info-value">${dataEntradaFormatada}</span></div>
                            <div><span class="info-label">Tipo:</span> <span class="info-value">${dados.tipoEntrada || '-'}</span></div>
                            <div><span class="info-label">PreÃ§o:</span> <span class="info-value">${dados.precoEntrada || '-'}</span></div>
                            <div><span class="info-label">Stop Loss:</span> <span class="info-value">${dados.stopLoss || '-'}</span></div>
                            <div><span class="info-label">Take Profit:</span> <span class="info-value">${dados.takeProfit || '-'}</span></div>
                            <div><span class="info-label">Lote:</span> <span class="info-value">${dados.lote || '-'}</span></div>
                            <div><span class="info-label">Sentimento:</span> <span class="info-value">${dados.sentimentoAbertura || '-'}</span></div>
                        </div>
                        
                        ${dados.imgEntradaBase64 ? `
                        <div class="image-box">
                            <h3 style="font-size: 1rem; margin-bottom: 0.2rem;">Imagem da Entrada</h3>
                            <img src="${dados.imgEntradaBase64}" alt="Imagem Entrada">
                        </div>` : ''}
                        
                        <div class="observacao">
                            <strong>ObservaÃ§Ã£o Abertura:</strong> ${dados.obsAbertura || '-'}
                        </div>

                        <h2>Fechamento</h2>
                        <div class="info-grid">
                            <div><span class="info-label">Fechado com:</span> <span class="info-value">${dados.fechadoCom || '-'}</span></div>
                            <div><span class="info-label">Lucro Bruto:</span> <span class="info-value">${formatarMoeda(dados.lucroBruto || 0)}</span></div>
                            <div><span class="info-label">ComissÃ£o:</span> <span class="info-value">${formatarMoeda(dados.comissao || 0)}</span></div>
                            <div><span class="info-label">Swap:</span> <span class="info-value">${formatarMoeda(dados.swap || 0)}</span></div>
                            <div><span class="info-label">Resultado LÃ­quido:</span> <span class="info-value">${valorFormatado}</span></div>
                            <div><span class="info-label">Data/Hora:</span> <span class="info-value">${dataFechamentoFormatada}</span></div>
                            <div><span class="info-label">Sentimento:</span> <span class="info-value">${dados.sentimentoFechamento || '-'}</span></div>
                        </div>
                        
                        ${dados.imgFechamentoBase64 ? `
                        <div class="image-box">
                            <h3 style="font-size: 1rem; margin-bottom: 0.2rem;">Imagem do Fechamento</h3>
                            <img src="${dados.imgFechamentoBase64}" alt="Imagem Fechamento">
                        </div>` : ''}
                        
                        <div class="observacao">
                            <strong>ObservaÃ§Ã£o Fechamento:</strong> ${dados.obsFechamento || '-'}
                        </div>

                        <div class="footer">
                            Documento gerado em ${new Date().toLocaleString('pt-BR')}
                        </div>
                    </body>
                    </html>
                `;

                const printWindow = window.open('', '_blank');
                printWindow.document.write(html);
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
            }

            // ========== IMPORTAÃ‡ÃƒO DE TRADES DO EXCEL (MT5) ==========
            document.getElementById('importarMT5Btn').addEventListener('click', () => {
                document.getElementById('arquivoMT5').click();
            });

            document.getElementById('arquivoMT5').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                Swal.fire({
                    title: 'Importando...',
                    text: 'Lendo arquivo, por favor aguarde.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                try {
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[firstSheet];
                    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });

                    // ---- LER SEÃ‡ÃƒO "POSIÃ‡Ã•ES" (trades) ----
                    let inicioPosicoes = -1;
                    let cabecalhoPosicoes = -1;
                    for (let i = 0; i < rows.length; i++) {
                        const row = rows[i];
                        if (row[0] && row[0].toString().trim() === 'PosiÃ§Ãµes') {
                            inicioPosicoes = i;
                            cabecalhoPosicoes = i + 1;
                            break;
                        }
                    }

                    if (inicioPosicoes !== -1) {
                        const headerRow = rows[cabecalhoPosicoes];
                        const colIndex = {
                            horarioAbertura: headerRow.findIndex(c => c && c.toString().includes('HorÃ¡rio')),
                            position: headerRow.findIndex(c => c && c.toString().includes('Position')),
                            ativo: headerRow.findIndex(c => c && c.toString().includes('Ativo')),
                            tipo: headerRow.findIndex(c => c && c.toString().includes('Tipo')),
                            volume: headerRow.findIndex(c => c && c.toString().includes('Volume')),
                            precoEntrada: headerRow.findIndex(c => c && c.toString().includes('PreÃ§o')),
                            stopLoss: headerRow.findIndex(c => c && c.toString().includes('S / L')),
                            takeProfit: headerRow.findIndex(c => c && c.toString().includes('T / P')),
                            horarioFechamento: -1,
                            precoFechamento: -1,
                            comissao: -1,
                            swap: -1,
                            lucro: -1
                        };

                        for (let j = 0; j < headerRow.length; j++) {
                            const cell = headerRow[j] ? headerRow[j].toString() : '';
                            if (cell.includes('HorÃ¡rio') && j !== colIndex.horarioAbertura) {
                                colIndex.horarioFechamento = j;
                            } else if (cell.includes('PreÃ§o') && j !== colIndex.precoEntrada) {
                                colIndex.precoFechamento = j;
                            } else if (cell.includes('ComissÃ£o')) {
                                colIndex.comissao = j;
                            } else if (cell.includes('Swap')) {
                                colIndex.swap = j;
                            } else if (cell.includes('Lucro')) {
                                colIndex.lucro = j;
                            }
                        }

                        if (colIndex.horarioAbertura !== -1 && colIndex.ativo !== -1 && colIndex.tipo !== -1 && colIndex.volume !== -1 && colIndex.precoEntrada !== -1) {
                            let importados = 0;
                            let atualizados = 0;
                            for (let i = cabecalhoPosicoes + 1; i < rows.length; i++) {
                                const row = rows[i];
                                if (!row[0] || (row[0] && row[0].toString().trim() === 'Ordens')) break;

                                const positionId = row[colIndex.position] ? row[colIndex.position].toString() : null;
                                if (!positionId) continue;

                                const ativo = row[colIndex.ativo] ? row[colIndex.ativo].toString().trim() : '';
                                const tipo = row[colIndex.tipo] ? row[colIndex.tipo].toString().toLowerCase() : '';
                                const volume = parseFloat(row[colIndex.volume]) || 0;
                                const precoEntrada = parseFloat(row[colIndex.precoEntrada]) || 0;
                                const stopLoss = row[colIndex.stopLoss] !== undefined ? parseFloat(row[colIndex.stopLoss]) : null;
                                const takeProfit = row[colIndex.takeProfit] !== undefined ? parseFloat(row[colIndex.takeProfit]) : null;
                                const horarioAberturaStr = row[colIndex.horarioAbertura] ? row[colIndex.horarioAbertura].toString().trim() : '';
                                const horarioFechamentoStr = colIndex.horarioFechamento !== -1 && row[colIndex.horarioFechamento] ? row[colIndex.horarioFechamento].toString().trim() : '';
                                const comissao = colIndex.comissao !== -1 ? parseFloat(row[colIndex.comissao]) || 0 : 0;
                                const swap = colIndex.swap !== -1 ? parseFloat(row[colIndex.swap]) || 0 : 0;
                                const lucro = colIndex.lucro !== -1 ? parseFloat(row[colIndex.lucro]) || 0 : 0;

                                function converterData(dataStr) {
                                    if (!dataStr) return '';
                                    let partes = dataStr.split(' ');
                                    if (partes.length < 2) return '';
                                    let dataPartes = partes[0].split('.');
                                    if (dataPartes.length !== 3) return '';
                                    let ano = dataPartes[0];
                                    let mes = dataPartes[1];
                                    let dia = dataPartes[2];
                                    let horaPartes = partes[1].split(':');
                                    let hora = horaPartes[0];
                                    let min = horaPartes[1];
                                    return `${ano}-${mes}-${dia}T${hora}:${min}`;
                                }

                                const dataEntrada = converterData(horarioAberturaStr);
                                const dataFechamento = converterData(horarioFechamentoStr);

                                if (!ativo || !tipo || !dataEntrada) continue;

                                let tipoEntrada = '';
                                if (tipo === 'buy' || tipo === 'compra') tipoEntrada = 'Compra';
                                else if (tipo === 'sell' || tipo === 'venda') tipoEntrada = 'Venda';
                                else continue;

                                const valorLiquido = lucro + comissao + swap; // comissao jÃ¡ negativa
                                const fechadoCom = valorLiquido > 0 ? 'Lucro' : (valorLiquido < 0 ? 'Prejuizo' : '');

                                let existingIndex = -1;
                                if (positionId) {
                                    existingIndex = trades.findIndex(t => t.positionId === positionId);
                                }
                                if (existingIndex === -1) {
                                    const dataDia = dataEntrada.slice(0,10);
                                    existingIndex = trades.findIndex(t => 
                                        t.dataEntrada && t.dataEntrada.slice(0,10) === dataDia &&
                                        t.moeda === ativo &&
                                        t.tipoEntrada === tipoEntrada
                                    );
                                }

                                if (existingIndex !== -1) {
                                    const trade = trades[existingIndex];
                                    trade.moeda = ativo;
                                    trade.dataEntrada = dataEntrada;
                                    trade.tipoEntrada = tipoEntrada;
                                    trade.precoEntrada = precoEntrada;
                                    trade.stopLoss = stopLoss;
                                    trade.takeProfit = takeProfit;
                                    trade.lote = volume;
                                    trade.dataFechamento = dataFechamento;
                                    trade.lucroBruto = lucro;
                                    trade.comissao = comissao;
                                    trade.swap = swap;
                                    trade.valor = valorLiquido;
                                    trade.fechadoCom = fechadoCom;
                                    trade.positionId = positionId;
                                    atualizados++;
                                } else {
                                    const novo = {
                                        id: Date.now() + Math.random() + positionId,
                                        positionId: positionId,
                                        moeda: ativo,
                                        dataEntrada: dataEntrada,
                                        tipoEntrada: tipoEntrada,
                                        precoEntrada: precoEntrada,
                                        stopLoss: stopLoss,
                                        takeProfit: takeProfit,
                                        lote: volume,
                                        dataFechamento: dataFechamento,
                                        lucroBruto: lucro,
                                        comissao: comissao,
                                        swap: swap,
                                        valor: valorLiquido,
                                        fechadoCom: fechadoCom,
                                        obsAbertura: '',
                                        sentimentoAbertura: '',
                                        obsFechamento: '',
                                        sentimentoFechamento: '',
                                        imgEntradaBase64: null,
                                        imgEntradaNome: null,
                                        imgFechamentoBase64: null,
                                        imgFechamentoNome: null
                                    };
                                    trades.push(novo);
                                    importados++;
                                }
                            }
                            console.log(`Trades: ${importados} novos, ${atualizados} atualizados`);
                        }
                    }

                    // ---- LER SEÃ‡ÃƒO "RESULTADOS" (totais) ----
                    let resumo = {
                        lucroLiquido: 0,
                        lucroBruto: 0,
                        perdaBruta: 0,
                        fatorLucro: 0,
                        retornoEsperado: 0,
                        fatorRecuperacao: 0,
                        sharpe: 0
                    };

                    for (let i = 0; i < rows.length; i++) {
                        const row = rows[i];
                        if (row[0] && row[0].toString().trim() === 'Resultados') {
                            const linhaResultados = rows[i + 1];
                            if (linhaResultados) {
                                const texto = linhaResultados.join(' ').replace(/\s+/g, ' ').trim();
                                const matchLucroLiq = texto.match(/Lucro LÃ­quido Total:\s*([+-]?\d+\.?\d*)/i);
                                if (matchLucroLiq) resumo.lucroLiquido = parseFloat(matchLucroLiq[1]);
                                const matchLucroBruto = texto.match(/Lucro Bruto:\s*([+-]?\d+\.?\d*)/i);
                                if (matchLucroBruto) resumo.lucroBruto = parseFloat(matchLucroBruto[1]);
                                const matchPerdaBruta = texto.match(/Perda Bruta:\s*([+-]?\d+\.?\d*)/i);
                                if (matchPerdaBruta) resumo.perdaBruta = parseFloat(matchPerdaBruta[1]);
                            }
                            const linhaFator = rows[i + 2];
                            if (linhaFator) {
                                const texto = linhaFator.join(' ').replace(/\s+/g, ' ').trim();
                                const matchFator = texto.match(/Fator de Lucro:\s*([+-]?\d+\.?\d*)/i);
                                if (matchFator) resumo.fatorLucro = parseFloat(matchFator[1]);
                                const matchRetorno = texto.match(/Retorno Esperado.*?\(.*?\):\s*([+-]?\d+\.?\d*)/i);
                                if (matchRetorno) resumo.retornoEsperado = parseFloat(matchRetorno[1]);
                            }
                            const linhaRecuperacao = rows[i + 3];
                            if (linhaRecuperacao) {
                                const texto = linhaRecuperacao.join(' ').replace(/\s+/g, ' ').trim();
                                const matchRecuperacao = texto.match(/Fator de RecuperaÃ§Ã£o:\s*([+-]?\d+\.?\d*)/i);
                                if (matchRecuperacao) resumo.fatorRecuperacao = parseFloat(matchRecuperacao[1]);
                                const matchSharpe = texto.match(/Ãndice de Sharpe:\s*([+-]?\d+\.?\d*)/i);
                                if (matchSharpe) resumo.sharpe = parseFloat(matchSharpe[1]);
                            }
                            break;
                        }
                    }

                    if (!contaAtual) {
                        if (contas.length === 0) {
                            contaAtual = {
                                nome: 'Conta Importada',
                                saldoInicial: 5000,
                                metaPercent: 10,
                                ddTipo: 'estatico',
                                ddMax: 7,
                                ddDiarioLimite: 2,
                                trades: trades,
                                resumoMT5: resumo
                            };
                            await salvarConta(contaAtual);
                            await carregarContaPorId(contaAtual.id);
                        } else {
                            contaAtual = contas[0];
                            contaAtual.trades = trades;
                            contaAtual.resumoMT5 = resumo;
                            await salvarConta(contaAtual);
                            await carregarContaPorId(contaAtual.id);
                        }
                    } else {
                        contaAtual.trades = trades;
                        contaAtual.resumoMT5 = resumo;
                        await salvarConta(contaAtual);
                    }

                    renderTrades();
                    atualizarMetricas();

                    Swal.fire({
                        icon: 'success',
                        title: 'ImportaÃ§Ã£o concluÃ­da',
                        html: `Trades importados/atualizados. Resumo do relatÃ³rio aplicado.`,
                        timer: 3000
                    });
                } catch (err) {
                    console.error(err);
                    Swal.fire('Erro na importaÃ§Ã£o', err.message, 'error');
                } finally {
                    document.getElementById('arquivoMT5').value = '';
                }
            });

            // ========== IMPRESSÃƒO DA LISTA (CORRIGIDA PARA MOSTRAR LUCRO BRUTO) ==========
            function imprimirLista() {
                const listaFiltrada = filtrarTrades();
                
                const estilo = `
                    <style>
                        body { font-family: 'Inter', sans-serif; padding: 2rem; color: #000; background: #fff; }
                        h1 { color: #2563eb; margin-bottom: 1rem; font-size: 2rem; }
                        h2 { color: #1e293b; margin-top: 2rem; }
                        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
                        th { background: #2563eb; color: white; padding: 0.75rem; text-align: left; }
                        td { padding: 0.75rem; border-bottom: 1px solid #e2e8f0; }
                        .lucro { color: #10b981; font-weight: 600; }
                        .prejuizo { color: #ef4444; font-weight: 600; }
                        .aberto { color: #f59e0b; }
                        .fechado { color: #10b981; }
                        .resumo { background: #f8fafc; padding: 1rem; border-radius: 0.5rem; margin-bottom: 2rem; }
                        .resumo-item { display: inline-block; margin-right: 2rem; }
                        .print-header { display: flex; justify-content: space-between; align-items: center; }
                    </style>
                `;

                // Para o resumo, usamos os valores lÃ­quidos (como antes)
                const totalLucro = listaFiltrada.filter(t => t.valor > 0).length;
                const totalPrejuizo = listaFiltrada.filter(t => t.valor < 0).length;
                const totalAbertos = listaFiltrada.filter(t => !t.fechadoCom).length;
                const somaValores = listaFiltrada.reduce((acc, t) => acc + (t.valor || 0), 0);

                let tabelaHtml = '';
                listaFiltrada.forEach(t => {
                    // Status baseado no lÃ­quido (como antes)
                    const status = !t.fechadoCom ? '<span class="aberto">â³ Aberto</span>' : 
                                  (t.valor > 0 ? '<span class="lucro">âœ… Lucro</span>' : '<span class="prejuizo">âŒ PrejuÃ­zo</span>');
                    // AGORA EXIBIMOS O LUCRO BRUTO
                    const valorExibido = t.fechadoCom ? formatarMoeda(t.lucroBruto) : '-';
                    
                    tabelaHtml += `
                        <tr>
                            <td>${t.moeda || '-'}</td>
                            <td>${t.dataEntrada ? t.dataEntrada.replace('T', ' ') : '-'}</td>
                            <td>${t.tipoEntrada || '-'}</td>
                            <td>${t.precoEntrada || '-'}</td>
                            <td>${t.stopLoss || '-'}</td>
                            <td>${t.takeProfit || '-'}</td>
                            <td>${t.lote || '-'}</td>
                            <td>${status}</td>
                            <td>${valorExibido}</td>
                            <td>${t.sentimentoAbertura || '-'} â†’ ${t.sentimentoFechamento || '-'}</td>
                        </tr>
                    `;
                });

                const html = `
                    <!DOCTYPE html>
                    <html>
                    <head><title>RelatÃ³rio de Trades</title>${estilo}</head>
                    <body>
                        <div class="print-header">
                            <h1>ğŸ“Š RelatÃ³rio de Trades</h1>
                            <p>Gerado em: ${new Date().toLocaleString('pt-BR')}</p>
                        </div>
                        
                        <div class="resumo">
                            <h3>Resumo do PerÃ­odo</h3>
                            <div class="resumo-item"><strong>Total de trades:</strong> ${listaFiltrada.length}</div>
                            <div class="resumo-item"><strong>Lucros:</strong> ${totalLucro}</div>
                            <div class="resumo-item"><strong>PrejuÃ­zos:</strong> ${totalPrejuizo}</div>
                            <div class="resumo-item"><strong>Abertos:</strong> ${totalAbertos}</div>
                            <div class="resumo-item"><strong>Resultado lÃ­quido:</strong> ${formatarMoeda(somaValores)}</div>
                        </div>

                        <h2>Detalhamento</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Moeda</th>
                                    <th>Entrada</th>
                                    <th>Tipo</th>
                                    <th>PreÃ§o</th>
                                    <th>Stop</th>
                                    <th>Target</th>
                                    <th>Lote</th>
                                    <th>Status</th>
                                    <th>Resultado</th>
                                    <th>Sentimento</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tabelaHtml}
                            </tbody>
                        </table>
                    </body>
                    </html>
                `;

                const iframe = document.createElement('iframe');
                iframe.style.position = 'absolute';
                iframe.style.width = '0';
                iframe.style.height = '0';
                iframe.style.border = 'none';
                document.body.appendChild(iframe);

                const iframeDoc = iframe.contentWindow.document;
                iframeDoc.open();
                iframeDoc.write(html);
                iframeDoc.close();

                iframe.onload = function() {
                    iframe.contentWindow.focus();
                    iframe.contentWindow.print();
                    setTimeout(() => {
                        document.body.removeChild(iframe);
                    }, 1000);
                };
            }

            // ========== DASHBOARD MODAL (COM RÃ“TULOS DE VALORES BRUTOS) ==========
            let chartEvolucao, chartPizza, chartDrawdown, chartMoeda, chartDiaSemana, chartHora, chartResultadoDiario;

            document.getElementById('dashboardButton').addEventListener('click', () => {
                abrirDashboard();
            });

            function abrirDashboard() {
                const tradesFechados = trades.filter(t => t.fechadoCom);
                
                const totalTrades = tradesFechados.length;
                const lucros = tradesFechados.filter(t => t.fechadoCom === 'Lucro');
                const prejuizos = tradesFechados.filter(t => t.fechadoCom === 'Prejuizo');
                
                // Valores lÃ­quidos para lucro lÃ­quido (usar resumo se disponÃ­vel)
                const indicadores = obterIndicadores(); // jÃ¡ usa resumo
                const lucroLiquido = indicadores.lucroLiquido;
                
                const winRate = totalTrades ? (lucros.length / totalTrades * 100).toFixed(1) : 0;
                
                // Valores brutos para as estatÃ­sticas (calculados diretamente dos trades)
                const lucrosBrutos = lucros.map(t => t.lucroBruto || 0);
                const prejuizosBrutos = prejuizos.map(t => t.lucroBruto || 0);
                const totalLucroBruto = lucrosBrutos.reduce((acc, v) => acc + v, 0);
                const totalPrejuizoBruto = prejuizosBrutos.reduce((acc, v) => acc + v, 0);
                
                // Profit factor: usar o do resumo, se disponÃ­vel, senÃ£o calcular
                const profitFactor = indicadores.fatorLucro.toFixed(2);
                
                const maiorLucro = lucrosBrutos.length ? Math.max(...lucrosBrutos) : 0;
                const maiorPrejuizo = prejuizosBrutos.length ? Math.min(...prejuizosBrutos) : 0; // mais negativo
                const mediaLucro = lucrosBrutos.length ? (totalLucroBruto / lucrosBrutos.length) : 0;
                const mediaPrejuizo = prejuizosBrutos.length ? (totalPrejuizoBruto / prejuizosBrutos.length) : 0;

                // Dados para grÃ¡fico de pizza com rÃ³tulos personalizados (usando valores brutos)
                const pizzaData = {
                    labels: [
                        `Lucros (${lucros.length} trade${lucros.length !== 1 ? 's' : ''})`,
                        `PrejuÃ­zos (${prejuizos.length} trade${prejuizos.length !== 1 ? 's' : ''})`
                    ],
                    datasets: [{
                        data: [lucros.length, prejuizos.length],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderColor: ['#059669', '#b91c1c'],
                        borderWidth: 1
                    }]
                };

                const tradesOrdenados = [...tradesFechados].sort((a, b) => new Date(a.dataEntrada) - new Date(b.dataEntrada));
                let saldoCorrente = config.saldoInicial;
                const evolucao = [];
                
                if (tradesOrdenados.length > 0) {
                    evolucao.push({ data: tradesOrdenados[0].dataEntrada.slice(0,10), saldo: config.saldoInicial });
                } else {
                    evolucao.push({ data: getLocalDateString(), saldo: config.saldoInicial });
                }
                
                tradesOrdenados.forEach(t => {
                    saldoCorrente += t.valor || 0;
                    evolucao.push({ data: t.dataEntrada ? t.dataEntrada.slice(0,10) : '', saldo: saldoCorrente });
                });
                
                const datasEvolucao = evolucao.map(e => e.data);
                const saldosEvolucao = evolucao.map(e => e.saldo);

                const diasComTrades = tradesFechados.map(t => t.dataEntrada.slice(0,10)).filter((v, i, a) => a.indexOf(v) === i).sort();
                let datasDrawdown = [];
                let valoresDrawdown = [];

                if (diasComTrades.length > 0) {
                    const primeiraData = new Date(diasComTrades[0]);
                    const ultimaData = new Date();
                    primeiraData.setHours(0,0,0,0);
                    ultimaData.setHours(0,0,0,0);
                    
                    const todasDatas = [];
                    const currentDate = new Date(primeiraData);
                    while (currentDate <= ultimaData) {
                        todasDatas.push(currentDate.toISOString().slice(0,10));
                        currentDate.setDate(currentDate.getDate() + 1);
                    }

                    const tradesPorDia = {};
                    tradesFechados.forEach(t => {
                        const dia = t.dataEntrada.slice(0,10);
                        if (!tradesPorDia[dia]) tradesPorDia[dia] = [];
                        tradesPorDia[dia].push(t);
                    });

                    let saldoAcumulado = config.saldoInicial;
                    
                    todasDatas.forEach(dia => {
                        const tradesDia = tradesPorDia[dia] || [];
                        tradesDia.sort((a, b) => new Date(a.dataEntrada) - new Date(b.dataEntrada));
                        
                        let saldoCorrenteDia = saldoAcumulado;
                        let menorSaldoDia = saldoAcumulado;
                        
                        tradesDia.forEach(t => {
                            saldoCorrenteDia += t.valor || 0;
                            if (saldoCorrenteDia < menorSaldoDia) menorSaldoDia = saldoCorrenteDia;
                        });
                        
                        let ddDia = 0;
                        if (menorSaldoDia < saldoAcumulado) {
                            ddDia = ((saldoAcumulado - menorSaldoDia) / saldoAcumulado) * 100;
                        }
                        
                        datasDrawdown.push(dia);
                        valoresDrawdown.push(ddDia);
                        
                        saldoAcumulado = saldoCorrenteDia;
                    });
                }

                const moedaCount = {};
                tradesFechados.forEach(t => {
                    moedaCount[t.moeda] = (moedaCount[t.moeda] || 0) + 1;
                });
                const moedaLabels = Object.keys(moedaCount);
                const moedaData = Object.values(moedaCount);

                const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'SÃ¡b'];
                const diaCount = [0, 0, 0, 0, 0, 0, 0];
                tradesFechados.forEach(t => {
                    const data = new Date(t.dataEntrada);
                    const dia = data.getDay();
                    diaCount[dia]++;
                });

                const horaCount = new Array(24).fill(0);
                tradesFechados.forEach(t => {
                    const data = new Date(t.dataEntrada);
                    const hora = data.getHours();
                    horaCount[hora]++;
                });

                // Para o grÃ¡fico de resultado diÃ¡rio, agrupar por dia e somar os valores brutos
                const resultadoPorDia = {};
                tradesFechados.forEach(t => {
                    const dia = t.dataEntrada.slice(0,10);
                    if (!resultadoPorDia[dia]) resultadoPorDia[dia] = 0;
                    resultadoPorDia[dia] += t.lucroBruto || 0; // usar bruto
                });
                const diasOrdenados = Object.keys(resultadoPorDia).sort();
                const valoresDiarios = diasOrdenados.map(d => resultadoPorDia[d]);
                const diasExibir = diasOrdenados.slice(-30);
                const valoresExibir = valoresDiarios.slice(-30);

                const modalHtml = `
                    <div style="max-height: 80vh; overflow-y: auto; padding: 0.5rem;">
                        <div class="dashboard-print-btn">
                            <button class="modal-btn-print" id="dashboard-imprimir">ğŸ–¨ï¸ Imprimir Dashboard</button>
                        </div>
                        
                        <div class="dashboard-stats">
                            <div class="stat-item">
                                <div class="stat-value">${totalTrades}</div>
                                <div class="stat-label">Total Trades</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${winRate}%</div>
                                <div class="stat-label">Win Rate</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${formatarMoeda(lucroLiquido)}</div>
                                <div class="stat-label">Lucro LÃ­quido</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${profitFactor}</div>
                                <div class="stat-label">Profit Factor</div>
                            </div>
                        </div>
                        
                        <div class="dashboard-stats" style="margin-top: 0.5rem;">
                            <div class="stat-item">
                                <div class="stat-value">${formatarMoeda(maiorLucro)}</div>
                                <div class="stat-label">Maior Lucro</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${formatarMoeda(Math.abs(maiorPrejuizo))}</div>
                                <div class="stat-label">Maior PrejuÃ­zo</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${formatarMoeda(mediaLucro)}</div>
                                <div class="stat-label">MÃ©dia Lucro</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${formatarMoeda(mediaPrejuizo)}</div>
                                <div class="stat-label">MÃ©dia PrejuÃ­zo</div>
                            </div>
                        </div>

                        <div class="dashboard-grid" style="grid-template-columns: 1fr;">
                            <div class="dashboard-card">
                                <h3>ğŸ“ˆ EvoluÃ§Ã£o do Saldo</h3>
                                <div class="dashboard-chart-container">
                                    <canvas id="chart-evolucao"></canvas>
                                </div>
                            </div>
                            <div class="dashboard-card">
                                <div class="dashboard-row-split">
                                    <div>
                                        <h3>ğŸ¥§ Resultados</h3>
                                        <div class="dashboard-chart-container">
                                            <canvas id="chart-pizza"></canvas>
                                        </div>
                                    </div>
                                    <div>
                                        <h3>ğŸ“‰ Drawdown DiÃ¡rio</h3>
                                        <div class="dashboard-chart-container">
                                            <canvas id="chart-drawdown"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="dashboard-grid" style="grid-template-columns: repeat(2, 1fr); margin-top: 1rem;">
                            <div class="dashboard-card">
                                <h3>ğŸ’° DistribuiÃ§Ã£o por Moeda</h3>
                                <div class="dashboard-chart-container">
                                    <canvas id="chart-moeda"></canvas>
                                </div>
                            </div>
                            <div class="dashboard-card">
                                <h3>ğŸ“… DistribuiÃ§Ã£o por Dia da Semana</h3>
                                <div class="dashboard-chart-container">
                                    <canvas id="chart-diasemana"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="dashboard-grid" style="grid-template-columns: repeat(2, 1fr); margin-top: 1rem;">
                            <div class="dashboard-card">
                                <h3>â° DistribuiÃ§Ã£o por Hora</h3>
                                <div class="dashboard-chart-container">
                                    <canvas id="chart-hora"></canvas>
                                </div>
                            </div>
                            <div class="dashboard-card">
                                <h3>ğŸ“Š Resultado DiÃ¡rio (Ãºltimos 30 dias)</h3>
                                <div class="dashboard-chart-container">
                                    <canvas id="chart-resultadodiario"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                Swal.fire({
                    title: 'ğŸ“Š Dashboard de Performance',
                    html: modalHtml,
                    showConfirmButton: true,
                    confirmButtonText: 'Fechar',
                    background: 'var(--bg-card)',
                    color: 'var(--text-primary)',
                    customClass: { popup: 'dashboard-modal' },
                    didOpen: () => {
                        const ctxEvolucao = document.getElementById('chart-evolucao').getContext('2d');
                        chartEvolucao = new Chart(ctxEvolucao, {
                            type: 'line',
                            data: {
                                labels: datasEvolucao,
                                datasets: [{
                                    label: 'Saldo (U$)',
                                    data: saldosEvolucao,
                                    borderColor: '#3b82f6',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    tension: 0.1,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                animation: false,
                                plugins: {
                                    legend: { display: false },
                                    datalabels: {
                                        color: '#fff',
                                        formatter: (value) => formatarMoeda(value),
                                        anchor: 'end',
                                        align: 'top',
                                        offset: 4
                                    }
                                },
                                scales: {
                                    y: { beginAtZero: false, grid: { color: 'rgba(255,255,255,0.1)' } },
                                    x: { grid: { display: false } }
                                }
                            },
                            plugins: [ChartDataLabels]
                        });

                        const ctxPizza = document.getElementById('chart-pizza').getContext('2d');
                        chartPizza = new Chart(ctxPizza, {
                            type: 'doughnut',
                            data: pizzaData,
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                animation: false,
                                plugins: {
                                    legend: { position: 'bottom', labels: { color: 'var(--text-primary)' } },
                                    datalabels: {
                                        color: '#fff',
                                        formatter: (value, context) => {
                                            const index = context.dataIndex;
                                            const total = index === 0 ? totalLucroBruto : totalPrejuizoBruto;
                                            return `${value} trade${value !== 1 ? 's' : ''}\n${formatarMoeda(total)}`;
                                        },
                                        font: { weight: 'bold', size: 11 },
                                        align: 'center',
                                        anchor: 'center'
                                    }
                                }
                            },
                            plugins: [ChartDataLabels]
                        });

                        const ctxDrawdown = document.getElementById('chart-drawdown').getContext('2d');
                        chartDrawdown = new Chart(ctxDrawdown, {
                            type: 'line',
                            data: {
                                labels: datasDrawdown,
                                datasets: [{
                                    label: 'Drawdown DiÃ¡rio (%)',
                                    data: valoresDrawdown,
                                    borderColor: '#ef4444',
                                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                    tension: 0.1,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                animation: false,
                                plugins: {
                                    legend: { display: false },
                                    datalabels: {
                                        color: '#fff',
                                        formatter: (value) => value.toFixed(1) + '%',
                                        anchor: 'end',
                                        align: 'top',
                                        offset: 4
                                    }
                                },
                                scales: {
                                    y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' } },
                                    x: { grid: { display: false } }
                                }
                            },
                            plugins: [ChartDataLabels]
                        });

                        const ctxMoeda = document.getElementById('chart-moeda').getContext('2d');
                        chartMoeda = new Chart(ctxMoeda, {
                            type: 'pie',
                            data: {
                                labels: moedaLabels,
                                datasets: [{
                                    data: moedaData,
                                    backgroundColor: [
                                        '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                                        '#ec4899', '#14b8a6', '#f97316', '#6366f1', '#84cc16'
                                    ],
                                    borderColor: 'var(--border)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                animation: false,
                                plugins: {
                                    legend: { position: 'bottom', labels: { color: 'var(--text-primary)' } },
                                    datalabels: {
                                        color: '#fff',
                                        formatter: (value) => value,
                                        font: { weight: 'bold' }
                                    }
                                }
                            },
                            plugins: [ChartDataLabels]
                        });

                        const ctxDiaSemana = document.getElementById('chart-diasemana').getContext('2d');
                        chartDiaSemana = new Chart(ctxDiaSemana, {
                            type: 'bar',
                            data: {
                                labels: diasSemana,
                                datasets: [{
                                    label: 'Quantidade de trades',
                                    data: diaCount,
                                    backgroundColor: '#3b82f6',
                                    borderRadius: 4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                animation: false,
                                plugins: {
                                    legend: { display: false },
                                    datalabels: {
                                        color: '#fff',
                                        formatter: (value) => value,
                                        anchor: 'end',
                                        align: 'top',
                                        offset: 4
                                    }
                                },
                                scales: {
                                    y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' } },
                                    x: { grid: { display: false } }
                                }
                            },
                            plugins: [ChartDataLabels]
                        });

                        const ctxHora = document.getElementById('chart-hora').getContext('2d');
                        chartHora = new Chart(ctxHora, {
                            type: 'bar',
                            data: {
                                labels: Array.from({ length: 24 }, (_, i) => i + 'h'),
                                datasets: [{
                                    label: 'Trades por hora',
                                    data: horaCount,
                                    backgroundColor: '#f59e0b',
                                    borderRadius: 4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                animation: false,
                                plugins: {
                                    legend: { display: false },
                                    datalabels: {
                                        color: '#fff',
                                        formatter: (value) => value,
                                        anchor: 'end',
                                        align: 'top',
                                        offset: 4
                                    }
                                },
                                scales: {
                                    y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' } },
                                    x: { grid: { display: false } }
                                }
                            },
                            plugins: [ChartDataLabels]
                        });

                        const ctxResultadoDiario = document.getElementById('chart-resultadodiario').getContext('2d');
                        chartResultadoDiario = new Chart(ctxResultadoDiario, {
                            type: 'bar',
                            data: {
                                labels: diasExibir,
                                datasets: [{
                                    label: 'Resultado (U$)',
                                    data: valoresExibir,
                                    backgroundColor: valoresExibir.map(v => v >= 0 ? '#10b981' : '#ef4444'),
                                    borderRadius: 4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                animation: false,
                                plugins: {
                                    legend: { display: false },
                                    datalabels: {
                                        color: '#fff',
                                        formatter: (value) => formatarMoeda(value),
                                        anchor: 'end',
                                        align: 'top',
                                        offset: 4
                                    }
                                },
                                scales: {
                                    y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' } },
                                    x: { grid: { display: false } }
                                }
                            },
                            plugins: [ChartDataLabels]
                        });

                        document.getElementById('dashboard-imprimir').addEventListener('click', () => {
                            // Em vez de capturar imagens, chamamos uma funÃ§Ã£o que recria os grÃ¡ficos no documento de impressÃ£o
                            imprimirDashboardRecriado(
                                totalTrades, winRate, lucroLiquido, profitFactor,
                                maiorLucro, maiorPrejuizo, mediaLucro, mediaPrejuizo,
                                datasEvolucao, saldosEvolucao,
                                lucros.length, prejuizos.length, totalLucroBruto, totalPrejuizoBruto,
                                datasDrawdown, valoresDrawdown,
                                moedaLabels, moedaData,
                                diasExibir, valoresExibir
                            );
                        });                        
                    }
                });
            }

            // ========== FUNÃ‡ÃƒO QUE RECRIA OS GRÃFICOS NO DOCUMENTO DE IMPRESSÃƒO EM DUAS PÃGINAS ==========
            function imprimirDashboardRecriado(
                totalTrades, winRate, lucroLiquido, profitFactor,
                maiorLucro, maiorPrejuizo, mediaLucro, mediaPrejuizo,
                datasEvolucao, saldosEvolucao,
                qtdLucros, qtdPrejuizos, totalLucroBruto, totalPrejuizoBruto,
                datasDrawdown, valoresDrawdown,
                moedaLabels, moedaData,
                diasExibir, valoresExibir
            ) {
                const estilos = `
                    <style>
                        @page { size: landscape; margin: 0.3cm; }
                        body { 
                            font-family: Arial, Helvetica, sans-serif; 
                            margin: 0; 
                            padding: 0; 
                            color: #000; 
                            background: #fff; 
                            font-size: 11pt;
                            width: 100%;
                            height: 100vh;
                            display: flex;
                            flex-direction: column;
                        }
                        h1 { 
                            color: #2563eb; 
                            font-size: 18pt; 
                            text-align: center; 
                            margin: 0 0 5px 0; 
                            padding: 0;
                        }
                        .stats-grid { 
                            display: flex; 
                            flex-wrap: wrap; 
                            justify-content: center; 
                            gap: 8px; 
                            margin: 5px 0; 
                        }
                        .stat-item { 
                            text-align: center; 
                            border: 1px solid #ccc; 
                            border-radius: 4px; 
                            padding: 3px 8px; 
                            background: #f5f5f5; 
                            min-width: 70px;
                        }
                        .stat-value { 
                            font-size: 14pt; 
                            font-weight: bold; 
                            color: #2563eb; 
                        }
                        .stat-label { 
                            font-size: 7pt; 
                            text-transform: uppercase; 
                            color: #333; 
                        }
                        .page {
                            page-break-after: always;
                            height: 100vh;
                            display: flex;
                            flex-direction: column;
                            padding: 5px;
                            box-sizing: border-box;
                        }
                        .page:last-child {
                            page-break-after: auto;
                        }
                        .chart-container { 
                            flex: 1;
                            min-height: 0;
                            margin: 5px 0;
                            position: relative; 
                            page-break-inside: avoid;
                        }
                        canvas { 
                            width: 100% !important; 
                            height: 100% !important; 
                        }
                        .footer { 
                            text-align: right; 
                            font-size: 8pt; 
                            color: #666; 
                            margin-top: 5px; 
                            border-top: 1px solid #ccc; 
                            padding-top: 3px; 
                            page-break-before: avoid;
                        }
                    </style>
                    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"><\/script>
                    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"><\/script>
                `;

                const conteudoHTML = `
                    <!DOCTYPE html>
                    <html>
                    <head><title>Dashboard Completo</title>${estilos}</head>
                    <body>
                        <h1>ğŸ“Š Dashboard de Performance</h1>
                        
                        <div class="stats-grid">
                            <div class="stat-item"><div class="stat-value">${totalTrades}</div><div class="stat-label">Total Trades</div></div>
                            <div class="stat-item"><div class="stat-value">${winRate}%</div><div class="stat-label">Win Rate</div></div>
                            <div class="stat-item"><div class="stat-value">${formatarMoeda(lucroLiquido)}</div><div class="stat-label">Lucro LÃ­quido</div></div>
                            <div class="stat-item"><div class="stat-value">${profitFactor}</div><div class="stat-label">Profit Factor</div></div>
                        </div>

                        <div class="stats-grid">
                            <div class="stat-item"><div class="stat-value">${formatarMoeda(maiorLucro)}</div><div class="stat-label">Maior Lucro</div></div>
                            <div class="stat-item"><div class="stat-value">${formatarMoeda(Math.abs(maiorPrejuizo))}</div><div class="stat-label">Maior PrejuÃ­zo</div></div>
                            <div class="stat-item"><div class="stat-value">${formatarMoeda(mediaLucro)}</div><div class="stat-label">MÃ©dia Lucro</div></div>
                            <div class="stat-item"><div class="stat-value">${formatarMoeda(mediaPrejuizo)}</div><div class="stat-label">MÃ©dia PrejuÃ­zo</div></div>
                        </div>

                        <!-- PÃ¡gina 1 -->
                        <div class="page">
                            <div class="chart-container">
                                <canvas id="evolucaoChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="drawdownChart"></canvas>
                            </div>
                        </div>

                        <!-- PÃ¡gina 2 -->
                        <div class="page">
                            <div class="chart-container">
                                <canvas id="resultadoDiarioChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="pizzaChart"></canvas>
                            </div>
                            <div class="footer">
                                Gerado em ${new Date().toLocaleString('pt-BR')}
                            </div>

                        </div>


                        <script>
                            // Registrar o plugin
                            Chart.register(ChartDataLabels);

                            // FunÃ§Ã£o auxiliar para formatar moeda
                            function formatarMoeda(valor) {
                                if (valor === null || valor === undefined || isNaN(valor)) return 'U$ 0,00';
                                var valorStr = valor.toFixed(2);
                                var partes = valorStr.split('.');
                                var inteiro = partes[0].replace(/\\B(?=(\\d{3})+(?!\\d))/g, '.');
                                return 'U$ ' + inteiro + ',' + partes[1];
                            }

                            // GrÃ¡fico de EvoluÃ§Ã£o (PÃ¡gina 1 - superior)
                            new Chart(document.getElementById('evolucaoChart'), {
                                type: 'line',
                                data: {
                                    labels: ${JSON.stringify(datasEvolucao)},
                                    datasets: [{
                                        label: 'Saldo (U$)',
                                        data: ${JSON.stringify(saldosEvolucao)},
                                        borderColor: '#3b82f6',
                                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                        tension: 0.1,
                                        fill: true
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    animation: false,
                                    plugins: {
                                        legend: { display: false },
                                        title: { display: true, text: 'ğŸ“ˆ EvoluÃ§Ã£o do Saldo' },
                                        datalabels: {
                                            color: '#000',
                                            formatter: function(value) {
                                                return formatarMoeda(value);
                                            },
                                            anchor: 'end',
                                            align: 'top',
                                            offset: 4,
                                            font: { weight: 'bold', size: 9 }
                                        }
                                    },
                                    scales: {
                                        y: { beginAtZero: false, grid: { color: 'rgba(0,0,0,0.1)' } },
                                        x: { grid: { display: false } }
                                    }
                                }
                            });

                            // GrÃ¡fico de Drawdown DiÃ¡rio (PÃ¡gina 1 - inferior)
                            new Chart(document.getElementById('drawdownChart'), {
                                type: 'line',
                                data: {
                                    labels: ${JSON.stringify(datasDrawdown)},
                                    datasets: [{
                                        label: 'Drawdown DiÃ¡rio (%)',
                                        data: ${JSON.stringify(valoresDrawdown)},
                                        borderColor: '#ef4444',
                                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                        tension: 0.1,
                                        fill: true
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    animation: false,
                                    plugins: {
                                        legend: { display: false },
                                        title: { display: true, text: 'ğŸ“‰ Drawdown DiÃ¡rio' },
                                        datalabels: {
                                            color: '#000',
                                            formatter: function(value) {
                                                return value.toFixed(1) + '%';
                                            },
                                            anchor: 'end',
                                            align: 'top',
                                            offset: 4,
                                            font: { weight: 'bold', size: 9 }
                                        }
                                    },
                                    scales: {
                                        y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.1)' } },
                                        x: { grid: { display: false } }
                                    }
                                }
                            });

                            // GrÃ¡fico de Resultado DiÃ¡rio (PÃ¡gina 2 - superior)
                            new Chart(document.getElementById('resultadoDiarioChart'), {
                                type: 'bar',
                                data: {
                                    labels: ${JSON.stringify(diasExibir)},
                                    datasets: [{
                                        label: 'Resultado (U$)',
                                        data: ${JSON.stringify(valoresExibir)},
                                        backgroundColor: ${JSON.stringify(valoresExibir.map(v => v >= 0 ? '#10b981' : '#ef4444'))},
                                        borderRadius: 4
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    animation: false,
                                    plugins: {
                                        legend: { display: false },
                                        title: { display: true, text: 'ğŸ“Š Resultado DiÃ¡rio (Ãºltimos 30 dias)' },
                                        datalabels: {
                                            color: '#000',
                                            formatter: function(value) {
                                                return formatarMoeda(value);
                                            },
                                            anchor: 'end',
                                            align: 'top',
                                            offset: 4,
                                            font: { weight: 'bold', size: 9 }
                                        }
                                    },
                                    scales: {
                                        y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.1)' } },
                                        x: { grid: { display: false } }
                                    }
                                }
                            });

                            // GrÃ¡fico de Pizza (Resultados) (PÃ¡gina 2 - inferior)
                            new Chart(document.getElementById('pizzaChart'), {
                                type: 'doughnut',
                                data: {
                                    labels: ['Lucros (${qtdLucros})', 'PrejuÃ­zos (${qtdPrejuizos})'],
                                    datasets: [{
                                        data: [${qtdLucros}, ${qtdPrejuizos}],
                                        backgroundColor: ['#10b981', '#ef4444'],
                                        borderColor: ['#059669', '#b91c1c'],
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    animation: false,
                                    plugins: {
                                        legend: { position: 'bottom', labels: { color: '#333' } },
                                        title: { display: true, text: 'ğŸ¥§ Resultados' },
                                        datalabels: {
                                            color: '#fff',
                                            formatter: function(value, context) {
                                                var total = context.dataIndex === 0 ? ${totalLucroBruto} : ${totalPrejuizoBruto};
                                                return value + ' trade' + (value !== 1 ? 's' : '') + '\\n' + formatarMoeda(total);
                                            },
                                            font: { weight: 'bold', size: 10 },
                                            align: 'center',
                                            anchor: 'center'
                                        }
                                    }
                                }
                            });
                        <\/script>
                    </body>
                    </html>
                `;

                const printWindow = window.open('', '_blank');
                printWindow.document.write(conteudoHTML);
                printWindow.document.close();
                printWindow.onload = () => {
                    printWindow.focus();
                    printWindow.print();
                };
            }


            // ========== GERENCIAMENTO DE CONTAS ==========
            document.getElementById('gerenciarContasBtn').addEventListener('click', () => {
                abrirGerenciadorContas();
            });

            async function abrirGerenciadorContas() {
                await carregarContas();

                let tabelaHtml = `
                    <div class="contas-header">
                        <button id="novaContaNoModal">â• Nova Conta</button>
                    </div>
                    <table class="contas-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Saldo Inicial</th>
                                <th>Meta %</th>
                                <th>DD MÃ¡x %</th>
                                <th>DD DiÃ¡rio %</th>
                                <th>Trades</th>
                                <th>Resultado</th>
                                <th>AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                contas.forEach(c => {
                    const tradesCount = c.trades ? c.trades.length : 0;
                    const resultado = c.trades ? c.trades.reduce((acc, t) => acc + (t.valor || 0), 0) : 0;
                    const resultadoStr = formatarMoeda(resultado);
                    tabelaHtml += `
                        <tr>
                            <td>${c.nome}</td>
                            <td>${formatarMoeda(c.saldoInicial)}</td>
                            <td>${c.metaPercent}%</td>
                            <td>${c.ddMax}%</td>
                            <td>${c.ddDiarioLimite}%</td>
                            <td>${tradesCount}</td>
                            <td>${resultadoStr}</td>
                            <td class="contas-actions">
                                <button class="editar-conta" data-id="${c.id}">âœï¸ Editar</button>
                                <button class="excluir-conta" data-id="${c.id}">ğŸ—‘ï¸ Excluir</button>
                                <button class="selecionar-conta" data-id="${c.id}">ğŸ” Selecionar</button>
                            </td>
                        </tr>
                    `;
                });

                tabelaHtml += `</tbody></table>`;

                Swal.fire({
                    title: 'ğŸ“‹ Gerenciar Contas',
                    html: tabelaHtml,
                    width: '90%',
                    customClass: { popup: 'contas-modal' },
                    background: 'var(--bg-card)',
                    color: 'var(--text-primary)',
                    showConfirmButton: false,
                    showCancelButton: true,
                    cancelButtonText: 'Fechar',
                    didOpen: () => {
                        document.getElementById('novaContaNoModal').addEventListener('click', () => {
                            criarNovaConta();
                        });
                        document.querySelectorAll('.editar-conta').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const contaId = parseInt(e.target.dataset.id);
                                editarConta(contaId);
                            });
                        });
                        document.querySelectorAll('.excluir-conta').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const contaId = parseInt(e.target.dataset.id);
                                excluirConta(contaId);
                            });
                        });
                        document.querySelectorAll('.selecionar-conta').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const contaId = parseInt(e.target.dataset.id);
                                carregarContaPorId(contaId).then(() => {
                                    Swal.close();
                                });
                            });
                        });
                    }
                });
            }

            async function criarNovaConta() {
                const result = await Swal.fire({
                    title: 'Nova Conta',
                    html: `
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; text-align: left; font-size: 0.8rem; color: var(--text-secondary);">Nome da Conta</label>
                            <input id="swal-nome-conta" class="swal2-input" placeholder="Ex: IcMarkets 5k" value="Nova Conta">
                        </div>
                        <div class="config-grid" style="margin-top: 0;">
                            <div class="config-row">
                                <div class="field-group">
                                    <label>Saldo Inicial (US$)</label>
                                    <input id="swal-input1" class="swal2-input" placeholder="Ex: 10000" value="10000">
                                </div>
                                <div class="field-group">
                                    <label>Meta de Lucro (%)</label>
                                    <input id="swal-input2" class="swal2-input" placeholder="Ex: 10" value="10">
                                </div>
                            </div>
                            <div class="config-row">
                                <div class="field-group">
                                    <label>Tipo de Drawdown MÃ¡ximo</label>
                                    <select id="swal-input3" class="swal2-select">
                                        <option value="estatico" selected>EstÃ¡tico</option>
                                        <option value="dinamico">DinÃ¢mico</option>
                                    </select>
                                </div>
                                <div class="field-group">
                                    <label>Limite de Drawdown MÃ¡x (%)</label>
                                    <input id="swal-input4" class="swal2-input" placeholder="Ex: 7" value="7">
                                </div>
                            </div>
                            <div class="config-row config-full">
                                <div class="field-group">
                                    <label>Limite de Drawdown DiÃ¡rio (%)</label>
                                    <input id="swal-input5" class="swal2-input" placeholder="Ex: 2" value="2">
                                </div>
                            </div>
                        </div>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'Criar',
                    cancelButtonText: 'Cancelar',
                    background: 'var(--bg-card)',
                    color: 'var(--text-primary)',
                    width: '500px',
                    preConfirm: () => {
                        const nome = document.getElementById('swal-nome-conta').value.trim();
                        const novoSaldo = parseFloat(document.getElementById('swal-input1').value);
                        const novaMeta = parseFloat(document.getElementById('swal-input2').value);
                        const novoTipo = document.getElementById('swal-input3').value;
                        const novoDdMax = parseFloat(document.getElementById('swal-input4').value);
                        const novoDdDiario = parseFloat(document.getElementById('swal-input5').value);
                        if (!nome || isNaN(novoSaldo) || isNaN(novaMeta) || isNaN(novoDdMax) || isNaN(novoDdDiario)) {
                            Swal.showValidationMessage('Preencha todos os campos corretamente');
                            return false;
                        }
                        return { nome, saldo: novoSaldo, meta: novaMeta, tipo: novoTipo, ddMax: novoDdMax, ddDiario: novoDdDiario };
                    }
                });

                if (result.isConfirmed) {
                    const novaConta = {
                        nome: result.value.nome,
                        saldoInicial: result.value.saldo,
                        metaPercent: result.value.meta,
                        ddTipo: result.value.tipo,
                        ddMax: result.value.ddMax,
                        ddDiarioLimite: result.value.ddDiario,
                        trades: [],
                        resumoMT5: null
                    };
                    await salvarConta(novaConta);
                    const id = novaConta.id;
                    await carregarContaPorId(id);
                    Swal.fire('Conta criada!', '', 'success');
                    abrirGerenciadorContas();
                }
            }

            async function editarConta(contaId) {
                const conta = contas.find(c => c.id === contaId);
                if (!conta) return;

                const result = await Swal.fire({
                    title: 'Editar Conta',
                    customClass: { popup: 'config-swal' },
                    html: `
                        <div class="config-grid">
                            <div class="config-row">
                                <div class="field-group">
                                    <label>Nome da Conta</label>
                                    <input id="swal-nome" class="swal2-input" value="${conta.nome}">
                                </div>
                            </div>
                            <div class="config-row">
                                <div class="field-group">
                                    <label>Saldo Inicial (US$)</label>
                                    <input id="swal-input1" class="swal2-input" placeholder="Ex: 10000" value="${conta.saldoInicial}">
                                </div>
                                <div class="field-group">
                                    <label>Meta de Lucro (%)</label>
                                    <input id="swal-input2" class="swal2-input" placeholder="Ex: 10" value="${conta.metaPercent}">
                                </div>
                            </div>
                            <div class="config-row">
                                <div class="field-group">
                                    <label>Tipo de Drawdown MÃ¡ximo</label>
                                    <select id="swal-input3" class="swal2-select">
                                        <option value="estatico" ${conta.ddTipo === 'estatico' ? 'selected' : ''}>EstÃ¡tico</option>
                                        <option value="dinamico" ${conta.ddTipo === 'dinamico' ? 'selected' : ''}>DinÃ¢mico</option>
                                    </select>
                                </div>
                                <div class="field-group">
                                    <label>Limite de Drawdown MÃ¡x (%)</label>
                                    <input id="swal-input4" class="swal2-input" placeholder="Ex: 7" value="${conta.ddMax}">
                                </div>
                            </div>
                            <div class="config-row config-full">
                                <div class="field-group">
                                    <label>Limite de Drawdown DiÃ¡rio (%)</label>
                                    <input id="swal-input5" class="swal2-input" placeholder="Ex: 2" value="${conta.ddDiarioLimite}">
                                </div>
                            </div>
                        </div>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'Salvar',
                    cancelButtonText: 'Cancelar',
                    background: 'var(--bg-card)',
                    color: 'var(--text-primary)',
                    width: '500px',
                    preConfirm: () => {
                        const nome = document.getElementById('swal-nome').value.trim();
                        const novoSaldo = parseFloat(document.getElementById('swal-input1').value);
                        const novaMeta = parseFloat(document.getElementById('swal-input2').value);
                        const novoTipo = document.getElementById('swal-input3').value;
                        const novoDdMax = parseFloat(document.getElementById('swal-input4').value);
                        const novoDdDiario = parseFloat(document.getElementById('swal-input5').value);
                        if (!nome || isNaN(novoSaldo) || isNaN(novaMeta) || isNaN(novoDdMax) || isNaN(novoDdDiario)) {
                            Swal.showValidationMessage('Preencha todos os campos corretamente');
                            return false;
                        }
                        return { nome, saldo: novoSaldo, meta: novaMeta, tipo: novoTipo, ddMax: novoDdMax, ddDiario: novoDdDiario };
                    }
                });

                if (result.isConfirmed) {
                    conta.nome = result.value.nome;
                    conta.saldoInicial = result.value.saldo;
                    conta.metaPercent = result.value.meta;
                    conta.ddTipo = result.value.tipo;
                    conta.ddMax = result.value.ddMax;
                    conta.ddDiarioLimite = result.value.ddDiario;
                    await salvarConta(conta);
                    if (contaAtual && contaAtual.id === contaId) {
                        await carregarContaPorId(contaId);
                    }
                    Swal.fire('Conta atualizada!', '', 'success');
                    abrirGerenciadorContas();
                }
            }

            async function excluirConta(contaId) {
                if (contaAtual && contaAtual.id === contaId) {
                    Swal.fire('Aviso', 'VocÃª nÃ£o pode excluir a conta que estÃ¡ ativa. Selecione outra conta primeiro.', 'warning');
                    return;
                }
                const result = await Swal.fire({
                    title: 'Excluir conta?',
                    text: 'Todos os trades desta conta serÃ£o excluÃ­dos permanentemente.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Sim, excluir',
                    cancelButtonText: 'Cancelar'
                });
                if (result.isConfirmed) {
                    await excluirContaPorId(contaId);
                    if (contaAtual && contaAtual.id === contaId) {
                        contaAtual = null;
                        trades = [];
                    }
                    Swal.fire('Conta excluÃ­da!', '', 'success');
                    abrirGerenciadorContas();
                }
            }

            // ========== BACKUP CRIPTOGRAFADO ==========
            const ENCRYPTION_KEY = 'trader-diary-secret-key-2026';

            document.getElementById('fazerBackup').addEventListener('click', async () => {
                await carregarContas();
                const dados = { contas };
                const jsonString = JSON.stringify(dados);
                const encrypted = CryptoJS.AES.encrypt(jsonString, ENCRYPTION_KEY).toString();
                const blob = new Blob([encrypted], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                const agora = new Date();
                const dia = String(agora.getDate()).padStart(2, '0');
                const mes = String(agora.getMonth() + 1).padStart(2, '0');
                const ano = agora.getFullYear();
                const nomeArquivo = `BackupDiarioTrader-${dia}-${mes}-${ano}.enc`;
                
                a.download = nomeArquivo;
                a.click();
                URL.revokeObjectURL(url);
                Swal.fire('Backup criptografado!', `Arquivo ${nomeArquivo} salvo.`, 'success');
            });

            const fileInputBackup = document.getElementById('arquivoBackup');
            document.getElementById('restaurarBackup').addEventListener('click', () => {
                fileInputBackup.click();
            });

            fileInputBackup.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                Swal.fire({
                    title: 'Restaurar backup?',
                    text: 'Todos os dados atuais serÃ£o substituÃ­dos.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Sim, restaurar',
                    cancelButtonText: 'Cancelar'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            try {
                                const encryptedData = event.target.result;
                                const bytes = CryptoJS.AES.decrypt(encryptedData, ENCRYPTION_KEY);
                                const decryptedString = bytes.toString(CryptoJS.enc.Utf8);
                                
                                if (!decryptedString) {
                                    throw new Error('Falha na descriptografia');
                                }
                                
                                const backup = JSON.parse(decryptedString);
                                if (backup.contas && Array.isArray(backup.contas)) {
                                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                                    const store = transaction.objectStore(STORE_NAME);
                                    store.clear();
                                    for (const conta of backup.contas) {
                                        delete conta.id;
                                        store.add(conta);
                                    }
                                    transaction.oncomplete = async () => {
                                        await carregarContas();
                                        const ultimaId = localStorage.getItem('ultimaContaId');
                                        if (ultimaId && contas.some(c => c.id == ultimaId)) {
                                            await carregarContaPorId(parseInt(ultimaId));
                                        } else if (contas.length > 0) {
                                            await carregarContaPorId(contas[0].id);
                                        }
                                        Swal.fire('Restaurado!', 'Backup carregado com sucesso.', 'success');
                                    };
                                } else {
                                    throw new Error('Formato invÃ¡lido');
                                }
                            } catch (err) {
                                Swal.fire('Erro', 'Arquivo corrompido ou nÃ£o autorizado.', 'error');
                            }
                        };
                        reader.readAsText(file);
                    }
                });
                fileInputBackup.value = '';
            });

            // ========== IMPRESSÃƒO DA LISTA ==========
            document.getElementById('imprimirLista').addEventListener('click', imprimirLista);

            // ========== INICIALIZAÃ‡ÃƒO ==========
            async function inicializar() {
                try {
                    await abrirBanco();
                    await carregarContas();
                    if (contas.length === 0) {
                        const contaDemo = {
                            nome: 'Conta Demo',
                            saldoInicial: 5000,
                            metaPercent: 10,
                            ddTipo: 'estatico',
                            ddMax: 7,
                            ddDiarioLimite: 2,
                            trades: [],
                            resumoMT5: null
                        };
                        await salvarConta(contaDemo);
                        await carregarContas();
                    }
                    const ultimaId = localStorage.getItem('ultimaContaId');
                    if (ultimaId) {
                        const idNum = Number(ultimaId);
                        const contaEncontrada = contas.find(c => c.id === idNum);
                        if (contaEncontrada) {
                            await carregarContaPorId(idNum);
                        } else {
                            if (contas.length > 0) {
                                await carregarContaPorId(contas[0].id);
                            }
                        }
                    } else {
                        if (contas.length > 0) {
                            await carregarContaPorId(contas[0].id);
                        }
                    }
                } catch (err) {
                    console.error('Erro na inicializaÃ§Ã£o:', err);
                    Swal.fire('Erro', 'NÃ£o foi possÃ­vel inicializar o banco de dados.', 'error');
                }
            }

            inicializar();

            contaSelect.addEventListener('change', () => {
                const novaId = parseInt(contaSelect.value);
                if (novaId && (!contaAtual || novaId !== contaAtual.id)) {
                    carregarContaPorId(novaId);
                }
            });

        })();
    </script>
</body>
</html>